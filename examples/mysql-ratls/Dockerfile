# MySQL 8 with RA-TLS (Remote Attestation TLS) Support in SGX Enclave
#
# This is a SELF-CONTAINED Dockerfile - no external files are needed.
# All source code (C launcher, manifest template) is embedded as base64.
#
# NOTE: This Dockerfile uses base64 encoding for embedded files to ensure
# compatibility with both legacy Docker builder and BuildKit.
# (Heredoc syntax doesn't work correctly with the legacy builder)
#
# Architecture:
# - A C launcher program runs inside the SGX enclave
# - The launcher reads whitelist from smart contract (if configured)
# - The launcher uses execve() to replace itself with mysqld (same enclave)
# - RA-TLS is injected via LD_PRELOAD configured in the Gramine manifest
# - DCAP attestation is enabled for remote verification
#
# Features:
# - Mutual RA-TLS authentication (both client and server must be SGX-based)
# - Certificate-only MySQL authentication (no passwords)
# - Certificates generated at startup from SGX quotes using secp256k1 curve
# - Optional whitelist from smart contract (via CONTRACT_ADDRESS env var)
# - Pre-compiled Gramine manifest for immediate SGX execution
#
# Environment Variables:
#   CONTRACT_ADDRESS - Smart contract address to read whitelist from (optional)
#   RPC_URL - Ethereum RPC endpoint URL (required if CONTRACT_ADDRESS is set)
#
# Usage:
#   docker build -t mysql-ratls .
#   docker run -d \
#     --device=/dev/sgx_enclave \
#     --device=/dev/sgx_provision \
#     -e PCCS_API_KEY=your_api_key \
#     -e CONTRACT_ADDRESS=0x... \
#     -e RPC_URL=https://... \
#     -p 3306:3306 \
#     mysql-ratls
#

ARG BASE_IMAGE=ghcr.io/mccoysc/gramine-web3-wallet-docker:latest
FROM ${BASE_IMAGE}

LABEL org.opencontainers.image.description="MySQL 8 with RA-TLS (Remote Attestation TLS) support for SGX-based mutual authentication"
LABEL org.opencontainers.image.licenses=GPL-2.0

# Avoid interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Prevent services from starting during package installation
# This is standard practice for Docker builds - we don't want MySQL to start during apt-get install
RUN printf '#!/bin/sh\nexit 101\n' > /usr/sbin/policy-rc.d && \
    chmod +x /usr/sbin/policy-rc.d

# Install MySQL 8 server and development dependencies for launcher compilation
RUN apt-get update && apt-get install -y --no-install-recommends \
    mysql-server \
    mysql-client \
    libcurl4-openssl-dev \
    && rm -rf /var/lib/apt/lists/*

# Clean up default MySQL data directory (we use encrypted partition at runtime)
# and remove policy-rc.d since we're done with apt installations
RUN rm -rf /var/lib/mysql/* && rm -f /usr/sbin/policy-rc.d

# Rebuild libratls-quote-verify.so from the upstream gramine repo which now includes
# the fix to create parent directories before writing certificate/key files.
# This fixes the issue where the LD_PRELOAD constructor runs before the launcher's
# main() can create the directories.
# The fix was merged in gramine PR #60: https://github.com/mccoysc/gramine/pull/60
ARG GRAMINE_REPO=mccoysc/gramine
RUN set -eux; \
    apt-get update && apt-get install -y --no-install-recommends \
        git ninja-build meson pkg-config cmake nasm \
        python3 python3-pip python3-dev \
        libprotobuf-c-dev protobuf-c-compiler \
        libcurl4-openssl-dev \
        && rm -rf /var/lib/apt/lists/*; \
    curl -fsSL https://download.01.org/intel-sgx/sgx_repo/ubuntu/intel-sgx-deb.key | gpg --dearmor -o /usr/share/keyrings/intel-sgx.gpg; \
    echo 'deb [arch=amd64 signed-by=/usr/share/keyrings/intel-sgx.gpg] https://download.01.org/intel-sgx/sgx_repo/ubuntu jammy main' > /etc/apt/sources.list.d/intel-sgx.list; \
    apt-get update && apt-get install -y --no-install-recommends \
        libsgx-dcap-ql-dev \
        libsgx-dcap-quote-verify-dev \
        libsgx-headers \
        libsgx-urts \
        && rm -rf /var/lib/apt/lists/*; \
    cd /tmp; \
    git clone --depth 1 https://github.com/${GRAMINE_REPO}.git gramine-src; \
    cd gramine-src; \
    meson setup build/ \
        --buildtype=release \
        -Dsgx=enabled \
        -Ddirect=disabled \
        -Dlibc=none \
        -Dtests=disabled \
        -Ddcap=enabled; \
    ninja -C build/ tools/sgx/ra-tls/libratls-quote-verify.so; \
    RATLS_LIB_SRC=$(find build -name 'libratls-quote-verify.so' -print -quit); \
    if [ -z "$RATLS_LIB_SRC" ]; then echo "Failed to find rebuilt libratls-quote-verify.so"; exit 1; fi; \
    ldconfig; \
    RATLS_LIB_DST=$(ldconfig -p | awk '/libratls-quote-verify\.so /{print $NF; exit}'); \
    if [ -z "$RATLS_LIB_DST" ] || [ ! -f "$RATLS_LIB_DST" ]; then \
        echo "Cannot locate installed libratls-quote-verify.so to replace"; exit 1; \
    fi; \
    echo "Replacing $RATLS_LIB_DST with rebuilt $RATLS_LIB_SRC"; \
    cp "$RATLS_LIB_SRC" "$RATLS_LIB_DST"; \
    RATLS_RUNTIME_LINK="/usr/local/lib/x86_64-linux-gnu/gramine/runtime/glibc/libratls-quote-verify.so"; \
    if [ -L "$RATLS_RUNTIME_LINK" ]; then \
        echo "Updating runtime symlink: $RATLS_RUNTIME_LINK"; \
        rm -f "$RATLS_RUNTIME_LINK"; \
        ln -sf "$RATLS_LIB_DST" "$RATLS_RUNTIME_LINK"; \
    fi; \
    ldconfig; \
    cd /tmp && rm -rf gramine-src; \
    echo "Successfully rebuilt libratls-quote-verify.so from upstream gramine repo"

# Create directories for MySQL data and SSL certificates
RUN mkdir -p /var/lib/mysql /var/lib/mysql-ssl /var/run/mysqld \
    && chown -R mysql:mysql /var/lib/mysql /var/lib/mysql-ssl /var/run/mysqld \
    && chmod 755 /var/run/mysqld

# Create launcher directory
RUN mkdir -p /opt/mysql-ratls/launcher

# Download cJSON library (MIT licensed JSON parser)
RUN curl -fsSL https://raw.githubusercontent.com/DaveGamble/cJSON/v1.7.18/cJSON.c \
      -o /opt/mysql-ratls/launcher/cJSON.c && \
    curl -fsSL https://raw.githubusercontent.com/DaveGamble/cJSON/v1.7.18/cJSON.h \
      -o /opt/mysql-ratls/launcher/cJSON.h

# Embed the C launcher source code (base64 encoded for legacy Docker builder compatibility)
# To update: base64 -w0 mysql_ratls_launcher.c > mysql_ratls_launcher.c.b64
RUN echo 'LyoKICogTXlTUUwgUkEtVExTIExhdW5jaGVyCiAqIAogKiBUaGlzIHByb2dyYW0gcnVucyBpbnNpZGUgYSBHcmFtaW5lIFNHWCBlbmNsYXZlIGFuZDoKICogMS4gUmVhZHMgd2hpdGVsaXN0IGNvbmZpZ3VyYXRpb24gZnJvbSBhIHNtYXJ0IGNvbnRyYWN0IChpZiBDT05UUkFDVF9BRERSRVNTIGlzIHNldCkKICogMi4gU2V0cyB1cCBSQS1UTFMgZW52aXJvbm1lbnQgdmFyaWFibGVzCiAqIDMuIFVzZXMgZXhlY3ZlKCkgdG8gcmVwbGFjZSBpdHNlbGYgd2l0aCBteXNxbGQKICoKICogVGhlIGxhdW5jaGVyIGF2b2lkcyBjcmVhdGluZyBjaGlsZCBwcm9jZXNzZXMgaW4gdGhlIGVuY2xhdmUgYnkgdXNpbmcgZXhlY3ZlKCkKICogdG8gZGlyZWN0bHkgcmVwbGFjZSB0aGUgY3VycmVudCBwcm9jZXNzIHdpdGggbXlzcWxkLgogKi8KCiNkZWZpbmUgX0dOVV9TT1VSQ0UKI2luY2x1ZGUgPHN0ZGlvLmg+CiNpbmNsdWRlIDxzdGRsaWIuaD4KI2luY2x1ZGUgPHN0cmluZy5oPgojaW5jbHVkZSA8dW5pc3RkLmg+CiNpbmNsdWRlIDxlcnJuby5oPgojaW5jbHVkZSA8c3lzL3N0YXQuaD4KI2luY2x1ZGUgPHN5cy90eXBlcy5oPgojaW5jbHVkZSA8Y3VybC9jdXJsLmg+CgojaW5jbHVkZSAiY0pTT04uaCIKCi8qIENvbmZpZ3VyYXRpb24gY29uc3RhbnRzICovCiNkZWZpbmUgTVlTUUxEX1BBVEggIi91c3Ivc2Jpbi9teXNxbGQiCiNkZWZpbmUgREVGQVVMVF9DRVJUX1BBVEggIi92YXIvbGliL215c3FsLXNzbC9zZXJ2ZXItY2VydC5wZW0iCiNkZWZpbmUgREVGQVVMVF9LRVlfUEFUSCAiL2FwcC93YWxsZXQvbXlzcWwta2V5cy9zZXJ2ZXIta2V5LnBlbSIKI2RlZmluZSBERUZBVUxUX0RBVEFfRElSICIvYXBwL3dhbGxldC9teXNxbC1kYXRhIgojZGVmaW5lIElOSVRfU0VOVElORUxfRklMRSAiLm15c3FsX2luaXRpYWxpemVkIgojZGVmaW5lIElOSVRfU1FMX0ZJTEUgImluaXRfdXNlcnMuc3FsIgoKLyogZ2V0U0dYQ29uZmlnKCkgZnVuY3Rpb24gc2VsZWN0b3I6IGtlY2NhazI1NigiZ2V0U0dYQ29uZmlnKCkiKVswOjRdICovCiNkZWZpbmUgR0VUX1NHWF9DT05GSUdfU0VMRUNUT1IgIjB4MDYyZTIyNTIiCgovKiBNYXhpbXVtIHNpemVzICovCiNkZWZpbmUgTUFYX1VSTF9MRU4gMjA0OAojZGVmaW5lIE1BWF9SRVNQT05TRV9MRU4gKDEwMjQgKiAxMDI0KSAgLyogMU1CIG1heCByZXNwb25zZSAqLwojZGVmaW5lIE1BWF9QQVRIX0xFTiA0MDk2CgovKiBTdHJ1Y3R1cmUgdG8gaG9sZCBjdXJsIHJlc3BvbnNlICovCnN0cnVjdCBjdXJsX3Jlc3BvbnNlIHsKICAgIGNoYXIgKmRhdGE7CiAgICBzaXplX3Qgc2l6ZTsKfTsKCi8qIEN1cmwgd3JpdGUgY2FsbGJhY2sgKi8Kc3RhdGljIHNpemVfdCB3cml0ZV9jYWxsYmFjayh2b2lkICpjb250ZW50cywgc2l6ZV90IHNpemUsIHNpemVfdCBubWVtYiwgdm9pZCAqdXNlcnApIHsKICAgIHNpemVfdCByZWFsc2l6ZSA9IHNpemUgKiBubWVtYjsKICAgIHN0cnVjdCBjdXJsX3Jlc3BvbnNlICpyZXNwID0gKHN0cnVjdCBjdXJsX3Jlc3BvbnNlICopdXNlcnA7CiAgICAKICAgIGlmIChyZXNwLT5zaXplICsgcmVhbHNpemUgPiBNQVhfUkVTUE9OU0VfTEVOKSB7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbTGF1bmNoZXJdIFJlc3BvbnNlIHRvbyBsYXJnZSwgdHJ1bmNhdGluZ1xuIik7CiAgICAgICAgcmV0dXJuIDA7CiAgICB9CiAgICAKICAgIGNoYXIgKnB0ciA9IHJlYWxsb2MocmVzcC0+ZGF0YSwgcmVzcC0+c2l6ZSArIHJlYWxzaXplICsgMSk7CiAgICBpZiAoIXB0cikgewogICAgICAgIGZwcmludGYoc3RkZXJyLCAiW0xhdW5jaGVyXSBPdXQgb2YgbWVtb3J5XG4iKTsKICAgICAgICByZXR1cm4gMDsKICAgIH0KICAgIAogICAgcmVzcC0+ZGF0YSA9IHB0cjsKICAgIG1lbWNweSgmKHJlc3AtPmRhdGFbcmVzcC0+c2l6ZV0pLCBjb250ZW50cywgcmVhbHNpemUpOwogICAgcmVzcC0+c2l6ZSArPSByZWFsc2l6ZTsKICAgIHJlc3AtPmRhdGFbcmVzcC0+c2l6ZV0gPSAnXDAnOwogICAgCiAgICByZXR1cm4gcmVhbHNpemU7Cn0KCi8qIENyZWF0ZSBkaXJlY3RvcnkgcmVjdXJzaXZlbHkgKi8Kc3RhdGljIGludCBta2Rpcl9wKGNvbnN0IGNoYXIgKnBhdGgpIHsKICAgIGNoYXIgdG1wW01BWF9QQVRIX0xFTl07CiAgICBjaGFyICpwID0gTlVMTDsKICAgIHNpemVfdCBsZW47CiAgICAKICAgIHNucHJpbnRmKHRtcCwgc2l6ZW9mKHRtcCksICIlcyIsIHBhdGgpOwogICAgbGVuID0gc3RybGVuKHRtcCk7CiAgICBpZiAodG1wW2xlbiAtIDFdID09ICcvJykKICAgICAgICB0bXBbbGVuIC0gMV0gPSAnXDAnOwogICAgCiAgICBmb3IgKHAgPSB0bXAgKyAxOyAqcDsgcCsrKSB7CiAgICAgICAgaWYgKCpwID09ICcvJykgewogICAgICAgICAgICAqcCA9ICdcMCc7CiAgICAgICAgICAgIGlmIChta2Rpcih0bXAsIDA3NTUpICE9IDAgJiYgZXJybm8gIT0gRUVYSVNUKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgKnAgPSAnLyc7CiAgICAgICAgfQogICAgfQogICAgCiAgICBpZiAobWtkaXIodG1wLCAwNzU1KSAhPSAwICYmIGVycm5vICE9IEVFWElTVCkgewogICAgICAgIHJldHVybiAtMTsKICAgIH0KICAgIAogICAgcmV0dXJuIDA7Cn0KCi8qIEdldCBkaXJlY3RvcnkgZnJvbSBwYXRoICovCnN0YXRpYyB2b2lkIGdldF9kaXJuYW1lKGNvbnN0IGNoYXIgKnBhdGgsIGNoYXIgKmRpciwgc2l6ZV90IGRpcl9zaXplKSB7CiAgICBzdHJuY3B5KGRpciwgcGF0aCwgZGlyX3NpemUgLSAxKTsKICAgIGRpcltkaXJfc2l6ZSAtIDFdID0gJ1wwJzsKICAgIAogICAgY2hhciAqbGFzdF9zbGFzaCA9IHN0cnJjaHIoZGlyLCAnLycpOwogICAgaWYgKGxhc3Rfc2xhc2gpIHsKICAgICAgICAqbGFzdF9zbGFzaCA9ICdcMCc7CiAgICB9Cn0KCi8qIENoZWNrIGlmIGZpbGUgZXhpc3RzICovCnN0YXRpYyBpbnQgZmlsZV9leGlzdHMoY29uc3QgY2hhciAqcGF0aCkgewogICAgc3RydWN0IHN0YXQgc3Q7CiAgICByZXR1cm4gc3RhdChwYXRoLCAmc3QpID09IDA7Cn0KCi8qIENoZWNrIGlmIE15U1FMIGlzIGluaXRpYWxpemVkIChzZW50aW5lbCBmaWxlIGV4aXN0cykgKi8Kc3RhdGljIGludCBpc19teXNxbF9pbml0aWFsaXplZChjb25zdCBjaGFyICpkYXRhX2RpcikgewogICAgY2hhciBzZW50aW5lbF9wYXRoW01BWF9QQVRIX0xFTl07CiAgICBzbnByaW50ZihzZW50aW5lbF9wYXRoLCBzaXplb2Yoc2VudGluZWxfcGF0aCksICIlcy8lcyIsIGRhdGFfZGlyLCBJTklUX1NFTlRJTkVMX0ZJTEUpOwogICAgcmV0dXJuIGZpbGVfZXhpc3RzKHNlbnRpbmVsX3BhdGgpOwp9CgovKiBDcmVhdGUgdGhlIGluaXRpYWxpemF0aW9uIFNRTCBmaWxlIGZvciBmaXJzdCBib290ICovCnN0YXRpYyBpbnQgY3JlYXRlX2luaXRfc3FsKGNvbnN0IGNoYXIgKmRhdGFfZGlyLCBjaGFyICppbml0X3NxbF9wYXRoLCBzaXplX3QgcGF0aF9zaXplKSB7CiAgICBzbnByaW50Zihpbml0X3NxbF9wYXRoLCBwYXRoX3NpemUsICIlcy8lcyIsIGRhdGFfZGlyLCBJTklUX1NRTF9GSUxFKTsKICAgIAogICAgRklMRSAqZiA9IGZvcGVuKGluaXRfc3FsX3BhdGgsICJ3Iik7CiAgICBpZiAoIWYpIHsKICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltMYXVuY2hlcl0gRmFpbGVkIHRvIGNyZWF0ZSBpbml0IFNRTCBmaWxlOiAlc1xuIiwgc3RyZXJyb3IoZXJybm8pKTsKICAgICAgICByZXR1cm4gLTE7CiAgICB9CiAgICAKICAgIC8qIFdyaXRlIGlkZW1wb3RlbnQgU1FMIHRvIGNyZWF0ZSBYLjUwOS1vbmx5IHVzZXJzICovCiAgICBmcHJpbnRmKGYsICItLSBNeVNRTCBSQS1UTFMgVXNlciBJbml0aWFsaXphdGlvblxuIik7CiAgICBmcHJpbnRmKGYsICItLSBUaGlzIGZpbGUgaXMgZXhlY3V0ZWQgb24gZmlyc3QgYm9vdCBpbnNpZGUgdGhlIFNHWCBlbmNsYXZlXG4iKTsKICAgIGZwcmludGYoZiwgIi0tIFVzZXJzIGFyZSBjb25maWd1cmVkIHdpdGggUkVRVUlSRSBYNTA5IChjZXJ0aWZpY2F0ZS1vbmx5IGF1dGhlbnRpY2F0aW9uKVxuIik7CiAgICBmcHJpbnRmKGYsICItLSBSQS1UTFMgaGFuZGxlcyB0aGUgYWN0dWFsIFNHWCBhdHRlc3RhdGlvbiB2ZXJpZmljYXRpb25cblxuIik7CiAgICAKICAgIAogICAgLyogQ3JlYXRlIGFwcGxpY2F0aW9uIHVzZXIgd2l0aCBYNTA5IHJlcXVpcmVtZW50ICovCiAgICBmcHJpbnRmKGYsICItLSBDcmVhdGUgYXBwbGljYXRpb24gdXNlciB0aGF0IHJlcXVpcmVzIFguNTA5IGNlcnRpZmljYXRlXG4iKTsKICAgIGZwcmludGYoZiwgIkNSRUFURSBVU0VSIElGIE5PVCBFWElTVFMgJ2FwcCdAJyUlJyBJREVOVElGSUVEIEJZICcnIFJFUVVJUkUgWDUwOTtcbiIpOwogICAgZnByaW50ZihmLCAiR1JBTlQgQUxMIFBSSVZJTEVHRVMgT04gKi4qIFRPICdhcHAnQCclJScgV0lUSCBHUkFOVCBPUFRJT047XG5cbiIpOwogICAgCiAgICAvKiBDcmVhdGUgYSByZWFkLW9ubHkgdXNlciB3aXRoIFg1MDkgcmVxdWlyZW1lbnQgKi8KICAgIGZwcmludGYoZiwgIi0tIENyZWF0ZSByZWFkLW9ubHkgdXNlciB0aGF0IHJlcXVpcmVzIFguNTA5IGNlcnRpZmljYXRlXG4iKTsKICAgIGZwcmludGYoZiwgIkNSRUFURSBVU0VSIElGIE5PVCBFWElTVFMgJ3JlYWRlcidAJyUlJyBJREVOVElGSUVEIEJZICcnIFJFUVVJUkUgWDUwOTtcbiIpOwogICAgZnByaW50ZihmLCAiR1JBTlQgU0VMRUNUIE9OICouKiBUTyAncmVhZGVyJ0AnJSUnO1xuXG4iKTsKICAgIAogICAgZnByaW50ZihmLCAiRkxVU0ggUFJJVklMRUdFUztcbiIpOwogICAgCiAgICBmY2xvc2UoZik7CiAgICAKICAgIHByaW50ZigiW0xhdW5jaGVyXSBDcmVhdGVkIGluaXQgU1FMIGZpbGU6ICVzXG4iLCBpbml0X3NxbF9wYXRoKTsKICAgIHJldHVybiAwOwp9CgovKiBDcmVhdGUgdGhlIHNlbnRpbmVsIGZpbGUgdG8gbWFyayBNeVNRTCBhcyBpbml0aWFsaXplZCAqLwpzdGF0aWMgaW50IGNyZWF0ZV9zZW50aW5lbF9maWxlKGNvbnN0IGNoYXIgKmRhdGFfZGlyKSB7CiAgICBjaGFyIHNlbnRpbmVsX3BhdGhbTUFYX1BBVEhfTEVOXTsKICAgIHNucHJpbnRmKHNlbnRpbmVsX3BhdGgsIHNpemVvZihzZW50aW5lbF9wYXRoKSwgIiVzLyVzIiwgZGF0YV9kaXIsIElOSVRfU0VOVElORUxfRklMRSk7CiAgICAKICAgIEZJTEUgKmYgPSBmb3BlbihzZW50aW5lbF9wYXRoLCAidyIpOwogICAgaWYgKCFmKSB7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbTGF1bmNoZXJdIEZhaWxlZCB0byBjcmVhdGUgc2VudGluZWwgZmlsZTogJXNcbiIsIHN0cmVycm9yKGVycm5vKSk7CiAgICAgICAgcmV0dXJuIC0xOwogICAgfQogICAgCiAgICBmcHJpbnRmKGYsICJNeVNRTCBpbml0aWFsaXplZCB3aXRoIFJBLVRMUyBYLjUwOSB1c2Vyc1xuIik7CiAgICBmY2xvc2UoZik7CiAgICAKICAgIHByaW50ZigiW0xhdW5jaGVyXSBDcmVhdGVkIHNlbnRpbmVsIGZpbGU6ICVzXG4iLCBzZW50aW5lbF9wYXRoKTsKICAgIHJldHVybiAwOwp9CgovKiBIZXggY2hhcmFjdGVyIHRvIGludGVnZXIgKi8Kc3RhdGljIGludCBoZXhfY2hhcl90b19pbnQoY2hhciBjKSB7CiAgICBpZiAoYyA+PSAnMCcgJiYgYyA8PSAnOScpIHJldHVybiBjIC0gJzAnOwogICAgaWYgKGMgPj0gJ2EnICYmIGMgPD0gJ2YnKSByZXR1cm4gYyAtICdhJyArIDEwOwogICAgaWYgKGMgPj0gJ0EnICYmIGMgPD0gJ0YnKSByZXR1cm4gYyAtICdBJyArIDEwOwogICAgcmV0dXJuIC0xOwp9CgovKiBEZWNvZGUgaGV4IHN0cmluZyB0byBieXRlcyAqLwpzdGF0aWMgaW50IGhleF9kZWNvZGUoY29uc3QgY2hhciAqaGV4LCB1bnNpZ25lZCBjaGFyICpvdXQsIHNpemVfdCBvdXRfbGVuKSB7CiAgICBzaXplX3QgaGV4X2xlbiA9IHN0cmxlbihoZXgpOwogICAgCiAgICAvKiBTa2lwIDB4IHByZWZpeCBpZiBwcmVzZW50ICovCiAgICBpZiAoaGV4X2xlbiA+PSAyICYmIGhleFswXSA9PSAnMCcgJiYgKGhleFsxXSA9PSAneCcgfHwgaGV4WzFdID09ICdYJykpIHsKICAgICAgICBoZXggKz0gMjsKICAgICAgICBoZXhfbGVuIC09IDI7CiAgICB9CiAgICAKICAgIGlmIChoZXhfbGVuICUgMiAhPSAwIHx8IGhleF9sZW4gLyAyID4gb3V0X2xlbikgewogICAgICAgIHJldHVybiAtMTsKICAgIH0KICAgIAogICAgZm9yIChzaXplX3QgaSA9IDA7IGkgPCBoZXhfbGVuIC8gMjsgaSsrKSB7CiAgICAgICAgaW50IGhpZ2ggPSBoZXhfY2hhcl90b19pbnQoaGV4W2kgKiAyXSk7CiAgICAgICAgaW50IGxvdyA9IGhleF9jaGFyX3RvX2ludChoZXhbaSAqIDIgKyAxXSk7CiAgICAgICAgaWYgKGhpZ2ggPCAwIHx8IGxvdyA8IDApIHJldHVybiAtMTsKICAgICAgICBvdXRbaV0gPSAoaGlnaCA8PCA0KSB8IGxvdzsKICAgIH0KICAgIAogICAgcmV0dXJuIGhleF9sZW4gLyAyOwp9CgovKiBEZWNvZGUgQUJJLWVuY29kZWQgc3RyaW5nIGZyb20gZXRoX2NhbGwgcmVzdWx0ICovCnN0YXRpYyBjaGFyICpkZWNvZGVfYWJpX3N0cmluZyhjb25zdCBjaGFyICpoZXhfcmVzdWx0KSB7CiAgICB1bnNpZ25lZCBjaGFyICpieXRlcyA9IE5VTEw7CiAgICBjaGFyICpyZXN1bHQgPSBOVUxMOwogICAgCiAgICAvKiBTa2lwIDB4IHByZWZpeCAqLwogICAgaWYgKHN0cmxlbihoZXhfcmVzdWx0KSA8IDIpIHJldHVybiBOVUxMOwogICAgY29uc3QgY2hhciAqaGV4ID0gaGV4X3Jlc3VsdDsKICAgIGlmIChoZXhbMF0gPT0gJzAnICYmIChoZXhbMV0gPT0gJ3gnIHx8IGhleFsxXSA9PSAnWCcpKSB7CiAgICAgICAgaGV4ICs9IDI7CiAgICB9CiAgICAKICAgIHNpemVfdCBoZXhfbGVuID0gc3RybGVuKGhleCk7CiAgICBpZiAoaGV4X2xlbiA8IDEyOCkgeyAgLyogTWluaW11bTogb2Zmc2V0ICg2NCkgKyBsZW5ndGggKDY0KSAqLwogICAgICAgIHJldHVybiBOVUxMOwogICAgfQogICAgCiAgICAvKiBBbGxvY2F0ZSBidWZmZXIgZm9yIGRlY29kZWQgYnl0ZXMgKi8KICAgIHNpemVfdCBieXRlc19sZW4gPSBoZXhfbGVuIC8gMjsKICAgIGJ5dGVzID0gbWFsbG9jKGJ5dGVzX2xlbik7CiAgICBpZiAoIWJ5dGVzKSByZXR1cm4gTlVMTDsKICAgIAogICAgaWYgKGhleF9kZWNvZGUoaGV4X3Jlc3VsdCwgYnl0ZXMsIGJ5dGVzX2xlbikgPCAwKSB7CiAgICAgICAgZnJlZShieXRlcyk7CiAgICAgICAgcmV0dXJuIE5VTEw7CiAgICB9CiAgICAKICAgIC8qIEZpcnN0IDMyIGJ5dGVzOiBvZmZzZXQgdG8gc3RyaW5nIGRhdGEgKHNob3VsZCBiZSAweDIwID0gMzIpICovCiAgICAvKiBOZXh0IDMyIGJ5dGVzIGF0IG9mZnNldDogc3RyaW5nIGxlbmd0aCAqLwogICAgLyogRm9sbG93aW5nIGJ5dGVzOiBzdHJpbmcgZGF0YSAqLwogICAgCiAgICAvKiBSZWFkIG9mZnNldCAoYmlnLWVuZGlhbiwgbGFzdCA0IGJ5dGVzIG9mIGZpcnN0IDMyKSAqLwogICAgc2l6ZV90IG9mZnNldCA9IDA7CiAgICBmb3IgKGludCBpID0gMjg7IGkgPCAzMjsgaSsrKSB7CiAgICAgICAgb2Zmc2V0ID0gKG9mZnNldCA8PCA4KSB8IGJ5dGVzW2ldOwogICAgfQogICAgCiAgICBpZiAob2Zmc2V0ICsgMzIgPiBieXRlc19sZW4pIHsKICAgICAgICBmcmVlKGJ5dGVzKTsKICAgICAgICByZXR1cm4gTlVMTDsKICAgIH0KICAgIAogICAgLyogUmVhZCBzdHJpbmcgbGVuZ3RoIGF0IG9mZnNldCAqLwogICAgc2l6ZV90IHN0cl9sZW4gPSAwOwogICAgZm9yIChpbnQgaSA9IDI4OyBpIDwgMzI7IGkrKykgewogICAgICAgIHN0cl9sZW4gPSAoc3RyX2xlbiA8PCA4KSB8IGJ5dGVzW29mZnNldCArIGldOwogICAgfQogICAgCiAgICBpZiAob2Zmc2V0ICsgMzIgKyBzdHJfbGVuID4gYnl0ZXNfbGVuKSB7CiAgICAgICAgZnJlZShieXRlcyk7CiAgICAgICAgcmV0dXJuIE5VTEw7CiAgICB9CiAgICAKICAgIC8qIEV4dHJhY3Qgc3RyaW5nICovCiAgICByZXN1bHQgPSBtYWxsb2Moc3RyX2xlbiArIDEpOwogICAgaWYgKCFyZXN1bHQpIHsKICAgICAgICBmcmVlKGJ5dGVzKTsKICAgICAgICByZXR1cm4gTlVMTDsKICAgIH0KICAgIAogICAgbWVtY3B5KHJlc3VsdCwgYnl0ZXMgKyBvZmZzZXQgKyAzMiwgc3RyX2xlbik7CiAgICByZXN1bHRbc3RyX2xlbl0gPSAnXDAnOwogICAgCiAgICBmcmVlKGJ5dGVzKTsKICAgIHJldHVybiByZXN1bHQ7Cn0KCi8qIENhbGwgRXRoZXJldW0gSlNPTi1SUEMgZXRoX2NhbGwgKi8Kc3RhdGljIGNoYXIgKmV0aF9jYWxsKGNvbnN0IGNoYXIgKnJwY191cmwsIGNvbnN0IGNoYXIgKmNvbnRyYWN0X2FkZHJlc3MsIGNvbnN0IGNoYXIgKmRhdGEpIHsKICAgIENVUkwgKmN1cmw7CiAgICBDVVJMY29kZSByZXM7CiAgICBzdHJ1Y3QgY3VybF9yZXNwb25zZSByZXNwb25zZSA9IHswfTsKICAgIGNoYXIgKnJlc3VsdCA9IE5VTEw7CiAgICBjaGFyIHBvc3RfZGF0YVtNQVhfVVJMX0xFTl07CiAgICBzdHJ1Y3QgY3VybF9zbGlzdCAqaGVhZGVycyA9IE5VTEw7CiAgICAKICAgIC8qIEJ1aWxkIEpTT04tUlBDIHJlcXVlc3QgKi8KICAgIHNucHJpbnRmKHBvc3RfZGF0YSwgc2l6ZW9mKHBvc3RfZGF0YSksCiAgICAgICAgIntcImpzb25ycGNcIjpcIjIuMFwiLFwiaWRcIjoxLFwibWV0aG9kXCI6XCJldGhfY2FsbFwiLCIKICAgICAgICAiXCJwYXJhbXNcIjpbe1widG9cIjpcIiVzXCIsXCJkYXRhXCI6XCIlc1wifSxcImxhdGVzdFwiXX0iLAogICAgICAgIGNvbnRyYWN0X2FkZHJlc3MsIGRhdGEpOwogICAgCiAgICBjdXJsID0gY3VybF9lYXN5X2luaXQoKTsKICAgIGlmICghY3VybCkgewogICAgICAgIGZwcmludGYoc3RkZXJyLCAiW0xhdW5jaGVyXSBGYWlsZWQgdG8gaW5pdGlhbGl6ZSBjdXJsXG4iKTsKICAgICAgICByZXR1cm4gTlVMTDsKICAgIH0KICAgIAogICAgcmVzcG9uc2UuZGF0YSA9IG1hbGxvYygxKTsKICAgIGlmICghcmVzcG9uc2UuZGF0YSkgewogICAgICAgIGN1cmxfZWFzeV9jbGVhbnVwKGN1cmwpOwogICAgICAgIHJldHVybiBOVUxMOwogICAgfQogICAgcmVzcG9uc2UuZGF0YVswXSA9ICdcMCc7CiAgICByZXNwb25zZS5zaXplID0gMDsKICAgIAogICAgaGVhZGVycyA9IGN1cmxfc2xpc3RfYXBwZW5kKGhlYWRlcnMsICJDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2pzb24iKTsKICAgIAogICAgY3VybF9lYXN5X3NldG9wdChjdXJsLCBDVVJMT1BUX1VSTCwgcnBjX3VybCk7CiAgICBjdXJsX2Vhc3lfc2V0b3B0KGN1cmwsIENVUkxPUFRfUE9TVEZJRUxEUywgcG9zdF9kYXRhKTsKICAgIGN1cmxfZWFzeV9zZXRvcHQoY3VybCwgQ1VSTE9QVF9IVFRQSEVBREVSLCBoZWFkZXJzKTsKICAgIGN1cmxfZWFzeV9zZXRvcHQoY3VybCwgQ1VSTE9QVF9XUklURUZVTkNUSU9OLCB3cml0ZV9jYWxsYmFjayk7CiAgICBjdXJsX2Vhc3lfc2V0b3B0KGN1cmwsIENVUkxPUFRfV1JJVEVEQVRBLCAmcmVzcG9uc2UpOwogICAgY3VybF9lYXN5X3NldG9wdChjdXJsLCBDVVJMT1BUX1RJTUVPVVQsIDMwTCk7CiAgICBjdXJsX2Vhc3lfc2V0b3B0KGN1cmwsIENVUkxPUFRfQ09OTkVDVFRJTUVPVVQsIDEwTCk7CiAgICAKICAgIHJlcyA9IGN1cmxfZWFzeV9wZXJmb3JtKGN1cmwpOwogICAgCiAgICBpZiAocmVzICE9IENVUkxFX09LKSB7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbTGF1bmNoZXJdIGN1cmwgZXJyb3I6ICVzXG4iLCBjdXJsX2Vhc3lfc3RyZXJyb3IocmVzKSk7CiAgICAgICAgZ290byBjbGVhbnVwOwogICAgfQogICAgCiAgICAvKiBQYXJzZSBKU09OIHJlc3BvbnNlICovCiAgICBjSlNPTiAqanNvbiA9IGNKU09OX1BhcnNlKHJlc3BvbnNlLmRhdGEpOwogICAgaWYgKCFqc29uKSB7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbTGF1bmNoZXJdIEZhaWxlZCB0byBwYXJzZSBKU09OIHJlc3BvbnNlXG4iKTsKICAgICAgICBnb3RvIGNsZWFudXA7CiAgICB9CiAgICAKICAgIC8qIENoZWNrIGZvciBlcnJvciAqLwogICAgY0pTT04gKmVycm9yID0gY0pTT05fR2V0T2JqZWN0SXRlbShqc29uLCAiZXJyb3IiKTsKICAgIGlmIChlcnJvcikgewogICAgICAgIGNKU09OICptZXNzYWdlID0gY0pTT05fR2V0T2JqZWN0SXRlbShlcnJvciwgIm1lc3NhZ2UiKTsKICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltMYXVuY2hlcl0gUlBDIGVycm9yOiAlc1xuIiwgCiAgICAgICAgICAgIG1lc3NhZ2UgPyBtZXNzYWdlLT52YWx1ZXN0cmluZyA6ICJ1bmtub3duIik7CiAgICAgICAgY0pTT05fRGVsZXRlKGpzb24pOwogICAgICAgIGdvdG8gY2xlYW51cDsKICAgIH0KICAgIAogICAgLyogR2V0IHJlc3VsdCAqLwogICAgY0pTT04gKnJlc3VsdF9qc29uID0gY0pTT05fR2V0T2JqZWN0SXRlbShqc29uLCAicmVzdWx0Iik7CiAgICBpZiAocmVzdWx0X2pzb24gJiYgcmVzdWx0X2pzb24tPnZhbHVlc3RyaW5nKSB7CiAgICAgICAgcmVzdWx0ID0gc3RyZHVwKHJlc3VsdF9qc29uLT52YWx1ZXN0cmluZyk7CiAgICB9CiAgICAKICAgIGNKU09OX0RlbGV0ZShqc29uKTsKICAgIApjbGVhbnVwOgogICAgY3VybF9zbGlzdF9mcmVlX2FsbChoZWFkZXJzKTsKICAgIGN1cmxfZWFzeV9jbGVhbnVwKGN1cmwpOwogICAgZnJlZShyZXNwb25zZS5kYXRhKTsKICAgIAogICAgcmV0dXJuIHJlc3VsdDsKfQoKLyogUmVhZCB3aGl0ZWxpc3QgZnJvbSBzbWFydCBjb250cmFjdCAqLwpzdGF0aWMgY2hhciAqcmVhZF93aGl0ZWxpc3RfZnJvbV9jb250cmFjdChjb25zdCBjaGFyICpjb250cmFjdF9hZGRyZXNzLCBjb25zdCBjaGFyICpycGNfdXJsKSB7CiAgICBjaGFyICp3aGl0ZWxpc3QgPSBOVUxMOwogICAgCiAgICBwcmludGYoIltMYXVuY2hlcl0gUmVhZGluZyB3aGl0ZWxpc3QgZnJvbSBjb250cmFjdC4uLlxuIik7CiAgICBwcmludGYoIltMYXVuY2hlcl0gICBDb250cmFjdDogJXNcbiIsIGNvbnRyYWN0X2FkZHJlc3MpOwogICAgcHJpbnRmKCJbTGF1bmNoZXJdICAgUlBDIFVSTDogJXNcbiIsIHJwY191cmwpOwogICAgCiAgICAvKiBDYWxsIGdldFNHWENvbmZpZygpICovCiAgICBjaGFyICpoZXhfcmVzdWx0ID0gZXRoX2NhbGwocnBjX3VybCwgY29udHJhY3RfYWRkcmVzcywgR0VUX1NHWF9DT05GSUdfU0VMRUNUT1IpOwogICAgaWYgKCFoZXhfcmVzdWx0KSB7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbTGF1bmNoZXJdIEZhaWxlZCB0byBjYWxsIGdldFNHWENvbmZpZygpXG4iKTsKICAgICAgICByZXR1cm4gTlVMTDsKICAgIH0KICAgIAogICAgLyogQ2hlY2sgZm9yIGVtcHR5IHJlc3VsdCAoMHggb3IgdmVyeSBzaG9ydCkgKi8KICAgIGlmIChzdHJsZW4oaGV4X3Jlc3VsdCkgPCA2NikgeyAgLyogMHggKyA2NCBjaGFycyBtaW5pbXVtICovCiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbTGF1bmNoZXJdIEVtcHR5IG9yIGludmFsaWQgcmVzcG9uc2UgZnJvbSBnZXRTR1hDb25maWcoKVxuIik7CiAgICAgICAgZnJlZShoZXhfcmVzdWx0KTsKICAgICAgICByZXR1cm4gTlVMTDsKICAgIH0KICAgIAogICAgLyogRGVjb2RlIEFCSS1lbmNvZGVkIHN0cmluZyAqLwogICAgY2hhciAqc2d4X2NvbmZpZyA9IGRlY29kZV9hYmlfc3RyaW5nKGhleF9yZXN1bHQpOwogICAgZnJlZShoZXhfcmVzdWx0KTsKICAgIAogICAgaWYgKCFzZ3hfY29uZmlnIHx8IHN0cmxlbihzZ3hfY29uZmlnKSA9PSAwKSB7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbTGF1bmNoZXJdIFNHWCBjb25maWcgaXMgZW1wdHlcbiIpOwogICAgICAgIGZyZWUoc2d4X2NvbmZpZyk7CiAgICAgICAgcmV0dXJuIE5VTEw7CiAgICB9CiAgICAKICAgIHByaW50ZigiW0xhdW5jaGVyXSBHb3QgU0dYIGNvbmZpZywgcGFyc2luZyBKU09OLi4uXG4iKTsKICAgIAogICAgLyogUGFyc2UgYXMgSlNPTiAqLwogICAgY0pTT04gKmpzb24gPSBjSlNPTl9QYXJzZShzZ3hfY29uZmlnKTsKICAgIGlmICghanNvbikgewogICAgICAgIGZwcmludGYoc3RkZXJyLCAiW0xhdW5jaGVyXSBGYWlsZWQgdG8gcGFyc2UgU0dYIGNvbmZpZyBhcyBKU09OXG4iKTsKICAgICAgICBmcmVlKHNneF9jb25maWcpOwogICAgICAgIHJldHVybiBOVUxMOwogICAgfQogICAgCiAgICAvKiBFeHRyYWN0IFJBVExTX1dISVRFTElTVF9DT05GSUcgZmllbGQgKi8KICAgIGNKU09OICp3aGl0ZWxpc3RfY29uZmlnID0gY0pTT05fR2V0T2JqZWN0SXRlbShqc29uLCAiUkFUTFNfV0hJVEVMSVNUX0NPTkZJRyIpOwogICAgaWYgKHdoaXRlbGlzdF9jb25maWcgJiYgd2hpdGVsaXN0X2NvbmZpZy0+dmFsdWVzdHJpbmcpIHsKICAgICAgICB3aGl0ZWxpc3QgPSBzdHJkdXAod2hpdGVsaXN0X2NvbmZpZy0+dmFsdWVzdHJpbmcpOwogICAgICAgIHByaW50ZigiW0xhdW5jaGVyXSBGb3VuZCBSQVRMU19XSElURUxJU1RfQ09ORklHIGluIFNHWCBjb25maWdcbiIpOwogICAgfSBlbHNlIHsKICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltMYXVuY2hlcl0gUkFUTFNfV0hJVEVMSVNUX0NPTkZJRyBmaWVsZCBub3QgZm91bmQgaW4gU0dYIGNvbmZpZ1xuIik7CiAgICB9CiAgICAKICAgIGNKU09OX0RlbGV0ZShqc29uKTsKICAgIGZyZWUoc2d4X2NvbmZpZyk7CiAgICAKICAgIHJldHVybiB3aGl0ZWxpc3Q7Cn0KCi8qIFNldCBlbnZpcm9ubWVudCB2YXJpYWJsZSB3aXRoIGxvZ2dpbmcgKi8Kc3RhdGljIHZvaWQgc2V0X2Vudihjb25zdCBjaGFyICpuYW1lLCBjb25zdCBjaGFyICp2YWx1ZSwgaW50IG92ZXJ3cml0ZSkgewogICAgaWYgKHNldGVudihuYW1lLCB2YWx1ZSwgb3ZlcndyaXRlKSA9PSAwKSB7CiAgICAgICAgcHJpbnRmKCJbTGF1bmNoZXJdIFNldCAlcz0lc1xuIiwgbmFtZSwgdmFsdWUpOwogICAgfSBlbHNlIHsKICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltMYXVuY2hlcl0gRmFpbGVkIHRvIHNldCAlczogJXNcbiIsIG5hbWUsIHN0cmVycm9yKGVycm5vKSk7CiAgICB9Cn0KCi8qIFNldCBlbnZpcm9ubWVudCB2YXJpYWJsZSBpZiBub3QgYWxyZWFkeSBzZXQgKi8Kc3RhdGljIHZvaWQgc2V0X2Vudl9kZWZhdWx0KGNvbnN0IGNoYXIgKm5hbWUsIGNvbnN0IGNoYXIgKmRlZmF1bHRfdmFsdWUpIHsKICAgIGNvbnN0IGNoYXIgKmN1cnJlbnQgPSBnZXRlbnYobmFtZSk7CiAgICBpZiAoIWN1cnJlbnQgfHwgc3RybGVuKGN1cnJlbnQpID09IDApIHsKICAgICAgICBzZXRfZW52KG5hbWUsIGRlZmF1bHRfdmFsdWUsIDEpOwogICAgfSBlbHNlIHsKICAgICAgICBwcmludGYoIltMYXVuY2hlcl0gVXNpbmcgZXhpc3RpbmcgJXM9JXNcbiIsIG5hbWUsIGN1cnJlbnQpOwogICAgfQp9CgppbnQgbWFpbihpbnQgYXJnYywgY2hhciAqYXJndltdKSB7CiAgICBwcmludGYoIj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuIik7CiAgICBwcmludGYoIk15U1FMIFJBLVRMUyBMYXVuY2hlciAoU0dYIEVuY2xhdmUpXG4iKTsKICAgIHByaW50ZigiPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbiIpOwogICAgCiAgICAvKiBJbml0aWFsaXplIGN1cmwgZ2xvYmFsbHkgKi8KICAgIGN1cmxfZ2xvYmFsX2luaXQoQ1VSTF9HTE9CQUxfREVGQVVMVCk7CiAgICAKICAgIC8qIEdldCBlbnZpcm9ubWVudCB2YXJpYWJsZXMgKi8KICAgIGNvbnN0IGNoYXIgKmNvbnRyYWN0X2FkZHJlc3MgPSBnZXRlbnYoIkNPTlRSQUNUX0FERFJFU1MiKTsKICAgIGNvbnN0IGNoYXIgKnJwY191cmwgPSBnZXRlbnYoIlJQQ19VUkwiKTsKICAgIGNvbnN0IGNoYXIgKmV4aXN0aW5nX3doaXRlbGlzdCA9IGdldGVudigiUkFUTFNfV0hJVEVMSVNUX0NPTkZJRyIpOwogICAgCiAgICAvKiBTdXBwcmVzcyB1bnVzZWQgdmFyaWFibGUgd2FybmluZyAqLwogICAgKHZvaWQpZXhpc3Rpbmdfd2hpdGVsaXN0OwogICAgCiAgICAvKiBTZXQgUkEtVExTIGNvbmZpZ3VyYXRpb24gKi8KICAgIHByaW50ZigiW0xhdW5jaGVyXSBTZXR0aW5nIHVwIFJBLVRMUyBjb25maWd1cmF0aW9uLi4uXG4iKTsKICAgIAogICAgLyogVXNlIHNlY3AyNTZrMSBjdXJ2ZSBmb3IgRXRoZXJldW0gY29tcGF0aWJpbGl0eSAqLwogICAgc2V0X2VudigiUkFfVExTX0NFUlRfQUxHT1JJVEhNIiwgInNlY3AyNTZrMSIsIDEpOwogICAgCiAgICAvKiBFbmFibGUgUkEtVExTIHZlcmlmaWNhdGlvbiBhbmQgcmVxdWlyZSBwZWVyIGNlcnRpZmljYXRlICovCiAgICBzZXRfZW52KCJSQVRMU19FTkFCTEVfVkVSSUZZIiwgIjEiLCAxKTsKICAgIHNldF9lbnYoIlJBVExTX1JFUVVJUkVfUEVFUl9DRVJUIiwgIjEiLCAxKTsKICAgIAogICAgLyogU2V0IGRlZmF1bHQgY2VydGlmaWNhdGUgYW5kIGtleSBwYXRocyAqLwogICAgc2V0X2Vudl9kZWZhdWx0KCJSQVRMU19DRVJUX1BBVEgiLCBERUZBVUxUX0NFUlRfUEFUSCk7CiAgICBzZXRfZW52X2RlZmF1bHQoIlJBVExTX0tFWV9QQVRIIiwgREVGQVVMVF9LRVlfUEFUSCk7CiAgICAKICAgIC8qIEdldCB0aGUgYWN0dWFsIHBhdGhzIGJlaW5nIHVzZWQgKi8KICAgIGNvbnN0IGNoYXIgKmNlcnRfcGF0aCA9IGdldGVudigiUkFUTFNfQ0VSVF9QQVRIIik7CiAgICBjb25zdCBjaGFyICprZXlfcGF0aCA9IGdldGVudigiUkFUTFNfS0VZX1BBVEgiKTsKICAgIAogICAgLyogQ3JlYXRlIGRpcmVjdG9yaWVzIGZvciBjZXJ0aWZpY2F0ZSBhbmQga2V5ICovCiAgICBjaGFyIGNlcnRfZGlyW01BWF9QQVRIX0xFTl07CiAgICBjaGFyIGtleV9kaXJbTUFYX1BBVEhfTEVOXTsKICAgIAogICAgZ2V0X2Rpcm5hbWUoY2VydF9wYXRoLCBjZXJ0X2Rpciwgc2l6ZW9mKGNlcnRfZGlyKSk7CiAgICBnZXRfZGlybmFtZShrZXlfcGF0aCwga2V5X2Rpciwgc2l6ZW9mKGtleV9kaXIpKTsKICAgIAogICAgcHJpbnRmKCJbTGF1bmNoZXJdIENyZWF0aW5nIGNlcnRpZmljYXRlIGRpcmVjdG9yeTogJXNcbiIsIGNlcnRfZGlyKTsKICAgIGlmIChta2Rpcl9wKGNlcnRfZGlyKSAhPSAwKSB7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbTGF1bmNoZXJdIFdhcm5pbmc6IEZhaWxlZCB0byBjcmVhdGUgY2VydCBkaXJlY3Rvcnk6ICVzXG4iLCBzdHJlcnJvcihlcnJubykpOwogICAgfQogICAgCiAgICAvKiBDcmVhdGUga2V5IGRpcmVjdG9yeSAoZW5jcnlwdGVkIHBhcnRpdGlvbiBwcm92aWRlcyBwcm90ZWN0aW9uKSAqLwogICAgcHJpbnRmKCJbTGF1bmNoZXJdIENyZWF0aW5nIGtleSBkaXJlY3Rvcnk6ICVzXG4iLCBrZXlfZGlyKTsKICAgIGlmIChta2Rpcl9wKGtleV9kaXIpICE9IDApIHsKICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltMYXVuY2hlcl0gV2FybmluZzogRmFpbGVkIHRvIGNyZWF0ZSBrZXkgZGlyZWN0b3J5OiAlc1xuIiwgc3RyZXJyb3IoZXJybm8pKTsKICAgIH0KICAgIAogICAgLyogQ3JlYXRlIGRhdGEgZGlyZWN0b3J5IGluc2lkZSB0aGUgZW5jbGF2ZSAoZW5jcnlwdGVkIHBhcnRpdGlvbikgKi8KICAgIGNvbnN0IGNoYXIgKmRhdGFfZGlyX2VudiA9IGdldGVudigiTVlTUUxfREFUQV9ESVIiKTsKICAgIGNvbnN0IGNoYXIgKmRhdGFfZGlyX3RvX2NyZWF0ZSA9IGRhdGFfZGlyX2VudiA/IGRhdGFfZGlyX2VudiA6IERFRkFVTFRfREFUQV9ESVI7CiAgICBwcmludGYoIltMYXVuY2hlcl0gQ3JlYXRpbmcgZGF0YSBkaXJlY3Rvcnk6ICVzXG4iLCBkYXRhX2Rpcl90b19jcmVhdGUpOwogICAgaWYgKG1rZGlyX3AoZGF0YV9kaXJfdG9fY3JlYXRlKSAhPSAwKSB7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbTGF1bmNoZXJdIFdhcm5pbmc6IEZhaWxlZCB0byBjcmVhdGUgZGF0YSBkaXJlY3Rvcnk6ICVzXG4iLCBzdHJlcnJvcihlcnJubykpOwogICAgfQogICAgCiAgICAvKiBDcmVhdGUgbG9ncyBkaXJlY3RvcnkgaW5zaWRlIHRoZSBlbmNyeXB0ZWQgcGFydGl0aW9uICovCiAgICBwcmludGYoIltMYXVuY2hlcl0gQ3JlYXRpbmcgbG9ncyBkaXJlY3Rvcnk6IC9hcHAvd2FsbGV0L215c3FsLWxvZ3NcbiIpOwogICAgaWYgKG1rZGlyX3AoIi9hcHAvd2FsbGV0L215c3FsLWxvZ3MiKSAhPSAwKSB7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbTGF1bmNoZXJdIFdhcm5pbmc6IEZhaWxlZCB0byBjcmVhdGUgbG9ncyBkaXJlY3Rvcnk6ICVzXG4iLCBzdHJlcnJvcihlcnJubykpOwogICAgfQogICAgCiAgICAvKiBIYW5kbGUgd2hpdGVsaXN0IGNvbmZpZ3VyYXRpb24gKi8KICAgIHByaW50ZigiXG5bTGF1bmNoZXJdIFdoaXRlbGlzdCBDb25maWd1cmF0aW9uOlxuIik7CiAgICAKICAgIGlmIChjb250cmFjdF9hZGRyZXNzICYmIHN0cmxlbihjb250cmFjdF9hZGRyZXNzKSA+IDApIHsKICAgICAgICBwcmludGYoIltMYXVuY2hlcl0gQ29udHJhY3QgYWRkcmVzcyBzcGVjaWZpZWQ6ICVzXG4iLCBjb250cmFjdF9hZGRyZXNzKTsKICAgICAgICAKICAgICAgICBpZiAoIXJwY191cmwgfHwgc3RybGVuKHJwY191cmwpID09IDApIHsKICAgICAgICAgICAgZnByaW50ZihzdGRlcnIsICJbTGF1bmNoZXJdIFdhcm5pbmc6IFJQQ19VUkwgbm90IHNldCwgY2Fubm90IHJlYWQgZnJvbSBjb250cmFjdFxuIik7CiAgICAgICAgICAgIHByaW50ZigiW0xhdW5jaGVyXSBGYWxsaW5nIGJhY2sgdG8gZW52aXJvbm1lbnQtYmFzZWQgd2hpdGVsaXN0IChpZiBzZXQpXG4iKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvKiBUcnkgdG8gcmVhZCB3aGl0ZWxpc3QgZnJvbSBjb250cmFjdCAqLwogICAgICAgICAgICBjaGFyICp3aGl0ZWxpc3QgPSByZWFkX3doaXRlbGlzdF9mcm9tX2NvbnRyYWN0KGNvbnRyYWN0X2FkZHJlc3MsIHJwY191cmwpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHdoaXRlbGlzdCkgewogICAgICAgICAgICAgICAgc2V0X2VudigiUkFUTFNfV0hJVEVMSVNUX0NPTkZJRyIsIHdoaXRlbGlzdCwgMSk7CiAgICAgICAgICAgICAgICBmcmVlKHdoaXRlbGlzdCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwcmludGYoIltMYXVuY2hlcl0gQ291bGQgbm90IHJlYWQgdmFsaWQgd2hpdGVsaXN0IGZyb20gY29udHJhY3RcbiIpOwogICAgICAgICAgICAgICAgcHJpbnRmKCJbTGF1bmNoZXJdIFVzaW5nIGVudmlyb25tZW50LWJhc2VkIHdoaXRlbGlzdCAoaWYgc2V0KVxuIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIHByaW50ZigiW0xhdW5jaGVyXSBObyBDT05UUkFDVF9BRERSRVNTIHNwZWNpZmllZFxuIik7CiAgICAgICAgcHJpbnRmKCJbTGF1bmNoZXJdIFVzaW5nIGVudmlyb25tZW50LWJhc2VkIHdoaXRlbGlzdCAoaWYgc2V0KVxuIik7CiAgICB9CiAgICAKICAgIC8qIERpc3BsYXkgd2hpdGVsaXN0IHN0YXR1cyAqLwogICAgY29uc3QgY2hhciAqZmluYWxfd2hpdGVsaXN0ID0gZ2V0ZW52KCJSQVRMU19XSElURUxJU1RfQ09ORklHIik7CiAgICBpZiAoZmluYWxfd2hpdGVsaXN0ICYmIHN0cmxlbihmaW5hbF93aGl0ZWxpc3QpID4gMCkgewogICAgICAgIHByaW50ZigiW0xhdW5jaGVyXSBSQVRMU19XSElURUxJU1RfQ09ORklHIGlzIHNldFxuIik7CiAgICAgICAgcHJpbnRmKCJbTGF1bmNoZXJdIE9ubHkgY2xpZW50cyBtYXRjaGluZyB0aGUgd2hpdGVsaXN0IGNhbiBjb25uZWN0XG4iKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcHJpbnRmKCJbTGF1bmNoZXJdIE5vIHdoaXRlbGlzdCBjb25maWd1cmVkXG4iKTsKICAgICAgICBwcmludGYoIltMYXVuY2hlcl0gQW55IHZhbGlkIFJBLVRMUyBjbGllbnQgY2FuIGNvbm5lY3RcbiIpOwogICAgfQogICAgCiAgICAvKiBDbGVhbiB1cCBjdXJsICovCiAgICBjdXJsX2dsb2JhbF9jbGVhbnVwKCk7CiAgICAKICAgIC8qIFByZXBhcmUgTXlTUUwgYXJndW1lbnRzICovCiAgICBwcmludGYoIlxuPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4iKTsKICAgIHByaW50ZigiU3RhcnRpbmcgTXlTUUwgU2VydmVyIHZpYSBleGVjdmUoKVxuIik7CiAgICBwcmludGYoIj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4iKTsKICAgIAogICAgY29uc3QgY2hhciAqZGF0YV9kaXIgPSBnZXRlbnYoIk1ZU1FMX0RBVEFfRElSIik7CiAgICBpZiAoIWRhdGFfZGlyKSBkYXRhX2RpciA9IERFRkFVTFRfREFUQV9ESVI7CiAgICAKICAgIC8qIENoZWNrIGlmIHRoaXMgaXMgZmlyc3QgYm9vdCAobmVlZCB0byBpbml0aWFsaXplIHVzZXJzKSAqLwogICAgaW50IGZpcnN0X2Jvb3QgPSAhaXNfbXlzcWxfaW5pdGlhbGl6ZWQoZGF0YV9kaXIpOwogICAgY2hhciBpbml0X3NxbF9wYXRoW01BWF9QQVRIX0xFTl0gPSB7MH07CiAgICBjaGFyIGluaXRfZmlsZV9hcmdbTUFYX1BBVEhfTEVOXSA9IHswfTsKICAgIAogICAgaWYgKGZpcnN0X2Jvb3QpIHsKICAgICAgICBwcmludGYoIltMYXVuY2hlcl0gRmlyc3QgYm9vdCBkZXRlY3RlZCAtIHdpbGwgY3JlYXRlIFguNTA5IHVzZXJzXG4iKTsKICAgICAgICAKICAgICAgICAvKiBDcmVhdGUgdGhlIGluaXQgU1FMIGZpbGUgaW4gdGhlIGVuY3J5cHRlZCBkYXRhIGRpcmVjdG9yeSAqLwogICAgICAgIGlmIChjcmVhdGVfaW5pdF9zcWwoZGF0YV9kaXIsIGluaXRfc3FsX3BhdGgsIHNpemVvZihpbml0X3NxbF9wYXRoKSkgPT0gMCkgewogICAgICAgICAgICBzbnByaW50Zihpbml0X2ZpbGVfYXJnLCBzaXplb2YoaW5pdF9maWxlX2FyZyksICItLWluaXQtZmlsZT0lcyIsIGluaXRfc3FsX3BhdGgpOwogICAgICAgICAgICBwcmludGYoIltMYXVuY2hlcl0gV2lsbCBleGVjdXRlIGluaXQgU1FMIG9uIHN0YXJ0dXA6ICVzXG4iLCBpbml0X3NxbF9wYXRoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltMYXVuY2hlcl0gV2FybmluZzogQ291bGQgbm90IGNyZWF0ZSBpbml0IFNRTCBmaWxlXG4iKTsKICAgICAgICAgICAgZmlyc3RfYm9vdCA9IDA7ICAvKiBEb24ndCBhZGQgLS1pbml0LWZpbGUgaWYgd2UgY291bGRuJ3QgY3JlYXRlIHRoZSBmaWxlICovCiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8qIENyZWF0ZSBzZW50aW5lbCBmaWxlIHRvIG1hcmsgYXMgaW5pdGlhbGl6ZWQgKi8KICAgICAgICAvKiBOb3RlOiBXZSBjcmVhdGUgaXQgbm93IHNvIHRoYXQgaWYgTXlTUUwgY3Jhc2hlcyBkdXJpbmcgaW5pdCwgd2UgZG9uJ3QgcmV0cnkgKi8KICAgICAgICAvKiBUaGUgaW5pdCBTUUwgaXMgaWRlbXBvdGVudCBhbnl3YXksIHNvIHJlLXJ1bm5pbmcgaXQgaXMgc2FmZSAqLwogICAgICAgIGNyZWF0ZV9zZW50aW5lbF9maWxlKGRhdGFfZGlyKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcHJpbnRmKCJbTGF1bmNoZXJdIE15U1FMIGFscmVhZHkgaW5pdGlhbGl6ZWQgLSBza2lwcGluZyB1c2VyIGNyZWF0aW9uXG4iKTsKICAgIH0KICAgIAogICAgLyogQnVpbGQgYXJndW1lbnQgbGlzdCBmb3IgbXlzcWxkICovCiAgICAvKiBXZSBuZWVkOiBteXNxbGQgLS1kYXRhZGlyPS4uLiAtLXNzbC1jZXJ0PS4uLiAtLXNzbC1rZXk9Li4uIC0tcmVxdWlyZS1zZWN1cmUtdHJhbnNwb3J0PU9OIFstLWluaXQtZmlsZT0uLi5dIFt1c2VyIGFyZ3NdICovCiAgICAvKiBOb3RlOiBObyAtLXVzZXI9bXlzcWwgc2luY2Ugd2UgcnVuIGFzIHJvb3QgaW4gY29udGFpbmVyICh1c2VyIHNhaWQgaXQncyBub3QgbmVlZGVkKSAqLwogICAgCiAgICBpbnQgZXh0cmFfYXJncyA9IGZpcnN0X2Jvb3QgPyA2IDogNTsgIC8qIEFkZCAxIGZvciAtLWluaXQtZmlsZSBvbiBmaXJzdCBib290ICovCiAgICBpbnQgbmV3X2FyZ2MgPSBhcmdjICsgZXh0cmFfYXJnczsKICAgIGNoYXIgKipuZXdfYXJndiA9IG1hbGxvYygobmV3X2FyZ2MgKyAxKSAqIHNpemVvZihjaGFyICopKTsKICAgIGlmICghbmV3X2FyZ3YpIHsKICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltMYXVuY2hlcl0gRmFpbGVkIHRvIGFsbG9jYXRlIG1lbW9yeSBmb3IgYXJndW1lbnRzXG4iKTsKICAgICAgICByZXR1cm4gMTsKICAgIH0KICAgIAogICAgLyogQnVpbGQgU1NMIGFyZ3VtZW50IHN0cmluZ3MgKi8KICAgIGNoYXIgc3NsX2NlcnRfYXJnW01BWF9QQVRIX0xFTl07CiAgICBjaGFyIHNzbF9rZXlfYXJnW01BWF9QQVRIX0xFTl07CiAgICBjaGFyIGRhdGFkaXJfYXJnW01BWF9QQVRIX0xFTl07CiAgICAKICAgIHNucHJpbnRmKHNzbF9jZXJ0X2FyZywgc2l6ZW9mKHNzbF9jZXJ0X2FyZyksICItLXNzbC1jZXJ0PSVzIiwgY2VydF9wYXRoKTsKICAgIHNucHJpbnRmKHNzbF9rZXlfYXJnLCBzaXplb2Yoc3NsX2tleV9hcmcpLCAiLS1zc2wta2V5PSVzIiwga2V5X3BhdGgpOwogICAgc25wcmludGYoZGF0YWRpcl9hcmcsIHNpemVvZihkYXRhZGlyX2FyZyksICItLWRhdGFkaXI9JXMiLCBkYXRhX2Rpcik7CiAgICAKICAgIGludCBpZHggPSAwOwogICAgbmV3X2FyZ3ZbaWR4KytdID0gTVlTUUxEX1BBVEg7CiAgICBuZXdfYXJndltpZHgrK10gPSBkYXRhZGlyX2FyZzsKICAgIG5ld19hcmd2W2lkeCsrXSA9IHNzbF9jZXJ0X2FyZzsKICAgIG5ld19hcmd2W2lkeCsrXSA9IHNzbF9rZXlfYXJnOwogICAgbmV3X2FyZ3ZbaWR4KytdID0gIi0tcmVxdWlyZS1zZWN1cmUtdHJhbnNwb3J0PU9OIjsKICAgIAogICAgLyogQWRkIC0taW5pdC1maWxlIG9uIGZpcnN0IGJvb3QgKi8KICAgIGlmIChmaXJzdF9ib290ICYmIGluaXRfZmlsZV9hcmdbMF0gIT0gJ1wwJykgewogICAgICAgIG5ld19hcmd2W2lkeCsrXSA9IGluaXRfZmlsZV9hcmc7CiAgICB9CiAgICAKICAgIC8qIENvcHkgYW55IGFkZGl0aW9uYWwgYXJndW1lbnRzIGZyb20gY29tbWFuZCBsaW5lICovCiAgICBmb3IgKGludCBpID0gMTsgaSA8IGFyZ2M7IGkrKykgewogICAgICAgIG5ld19hcmd2W2lkeCsrXSA9IGFyZ3ZbaV07CiAgICB9CiAgICBuZXdfYXJndltpZHhdID0gTlVMTDsKICAgIAogICAgcHJpbnRmKCJbTGF1bmNoZXJdIEV4ZWN1dGluZzogJXNcbiIsIE1ZU1FMRF9QQVRIKTsKICAgIHByaW50ZigiW0xhdW5jaGVyXSAgIERhdGEgZGlyZWN0b3J5OiAlc1xuIiwgZGF0YV9kaXIpOwogICAgcHJpbnRmKCJbTGF1bmNoZXJdICAgQ2VydGlmaWNhdGU6ICVzXG4iLCBjZXJ0X3BhdGgpOwogICAgcHJpbnRmKCJbTGF1bmNoZXJdICAgUHJpdmF0ZSBrZXk6ICVzXG4iLCBrZXlfcGF0aCk7CiAgICBpZiAoZmlyc3RfYm9vdCAmJiBpbml0X2ZpbGVfYXJnWzBdICE9ICdcMCcpIHsKICAgICAgICBwcmludGYoIltMYXVuY2hlcl0gICBJbml0IGZpbGU6ICVzXG4iLCBpbml0X3NxbF9wYXRoKTsKICAgIH0KICAgIHByaW50ZigiXG4iKTsKICAgIAogICAgLyogVXNlIGV4ZWN2ZSB0byByZXBsYWNlIHRoaXMgcHJvY2VzcyB3aXRoIG15c3FsZCAqLwogICAgLyogVGhpcyBwcmVzZXJ2ZXMgdGhlIGVudmlyb25tZW50IHZhcmlhYmxlcyB3ZSBzZXQgKi8KICAgIGV4ZWN2KE1ZU1FMRF9QQVRILCBuZXdfYXJndik7CiAgICAKICAgIC8qIElmIHdlIGdldCBoZXJlLCBleGVjdmUgZmFpbGVkICovCiAgICBmcHJpbnRmKHN0ZGVyciwgIltMYXVuY2hlcl0gRmFpbGVkIHRvIGV4ZWN1dGUgJXM6ICVzXG4iLCBNWVNRTERfUEFUSCwgc3RyZXJyb3IoZXJybm8pKTsKICAgIGZyZWUobmV3X2FyZ3YpOwogICAgCiAgICByZXR1cm4gMTsKfQo=' | base64 -d > /opt/mysql-ratls/launcher/mysql_ratls_launcher.c

# Compile and install the launcher directly with gcc
# Note: Using direct gcc instead of Makefile to ensure compatibility with
# both legacy Docker builder and BuildKit
RUN cd /opt/mysql-ratls/launcher && \
    gcc -Wall -Wextra -O2 -g -o mysql-ratls-launcher \
        mysql_ratls_launcher.c cJSON.c \
        -lcurl && \
    install -m 755 mysql-ratls-launcher /usr/local/bin/mysql-ratls-launcher && \
    echo "Launcher compiled and installed successfully"

# Embed the Gramine manifest template (base64 encoded for legacy Docker builder compatibility)
# To update: base64 -w0 mysql-ratls.manifest.template > mysql-ratls.manifest.template.b64
RUN echo 'IyBHcmFtaW5lIG1hbmlmZXN0IHRlbXBsYXRlIGZvciBNeVNRTCBSQS1UTFMKIyBUaGlzIG1hbmlmZXN0IHJ1bnMgdGhlIG15c3FsLXJhdGxzLWxhdW5jaGVyIHdoaWNoIHRoZW4gZXhlY3ZlKCkgdG8gbXlzcWxkCiMgQm90aCB0aGUgbGF1bmNoZXIgYW5kIG15c3FsZCBydW4gaW5zaWRlIHRoZSBzYW1lIFNHWCBlbmNsYXZlCgojIE5vdGU6IGxvYWRlci5lbnRyeXBvaW50IGlzIGF1dG9tYXRpY2FsbHkgc2V0IGJ5IGdyYW1pbmUtbWFuaWZlc3QgdG8gdGhlIExpYk9TCiMgbGlib3MuZW50cnlwb2ludCBzcGVjaWZpZXMgdGhlIGFjdHVhbCBhcHBsaWNhdGlvbiB0byBydW4gaW5zaWRlIHRoZSBlbmNsYXZlCmxpYm9zLmVudHJ5cG9pbnQgPSAie3sgZW50cnlwb2ludCB9fSIKCmxvYWRlci5sb2dfbGV2ZWwgPSAie3sgbG9nX2xldmVsIH19IgoKIyBFbnZpcm9ubWVudCB2YXJpYWJsZXMKbG9hZGVyLmVudi5MRF9MSUJSQVJZX1BBVEggPSAiL2xpYjovdXNyL2xpYjovbGliL3g4Nl82NC1saW51eC1nbnU6L3Vzci9saWIveDg2XzY0LWxpbnV4LWdudTovdXNyL2xvY2FsL2xpYjovdXNyL2xvY2FsL2xpYi94ODZfNjQtbGludXgtZ251Igpsb2FkZXIuZW52LlBBVEggPSAiL3Vzci9iaW46L2JpbjovdXNyL3NiaW46L3NiaW46L3Vzci9sb2NhbC9iaW4iCmxvYWRlci5lbnYuSE9NRSA9ICIvYXBwL3dhbGxldC9teXNxbC1kYXRhIgoKIyBSQS1UTFMgaW5qZWN0aW9uIHZpYSBMRF9QUkVMT0FECiMgVGhpcyBlbmFibGVzIHRyYW5zcGFyZW50IFJBLVRMUyBmb3IgTXlTUUwgY29ubmVjdGlvbnMKbG9hZGVyLmVudi5MRF9QUkVMT0FEID0gIi91c3IvbG9jYWwvbGliL3g4Nl82NC1saW51eC1nbnUvbGlicmF0bHMtcXVvdGUtdmVyaWZ5LnNvIgoKIyBSQS1UTFMgQ29uZmlndXJhdGlvbgojIFVzZSBzZWNwMjU2azEgY3VydmUgZm9yIEV0aGVyZXVtIGNvbXBhdGliaWxpdHkKbG9hZGVyLmVudi5SQV9UTFNfQ0VSVF9BTEdPUklUSE0gPSAic2VjcDI1NmsxIgoKIyBFbmFibGUgUkEtVExTIHZlcmlmaWNhdGlvbiBhbmQgcmVxdWlyZSBwZWVyIGNlcnRpZmljYXRlIGZvciBtdXR1YWwgVExTCmxvYWRlci5lbnYuUkFUTFNfRU5BQkxFX1ZFUklGWSA9ICIxIgpsb2FkZXIuZW52LlJBVExTX1JFUVVJUkVfUEVFUl9DRVJUID0gIjEiCgojIENlcnRpZmljYXRlIGFuZCBrZXkgcGF0aHMgKGZpeGVkIGluIG1hbmlmZXN0IGZvciBzZWN1cml0eSkKIyBDZXJ0aWZpY2F0ZSBjYW4gYmUgaW4gbm9ybWFsIGRpcmVjdG9yeQpsb2FkZXIuZW52LlJBVExTX0NFUlRfUEFUSCA9ICIvdmFyL2xpYi9teXNxbC1zc2wvc2VydmVyLWNlcnQucGVtIgojIFByaXZhdGUga2V5IE1VU1QgYmUgaW4gZW5jcnlwdGVkIHBhcnRpdGlvbgpsb2FkZXIuZW52LlJBVExTX0tFWV9QQVRIID0gIi9hcHAvd2FsbGV0L215c3FsLWtleXMvc2VydmVyLWtleS5wZW0iCgojIENvbnRyYWN0IGNvbmZpZ3VyYXRpb24gZm9yIHdoaXRlbGlzdCAocGFzc3Rocm91Z2ggZnJvbSBob3N0IGZvciBkZXBsb3ltZW50IGZsZXhpYmlsaXR5KQpsb2FkZXIuZW52LkNPTlRSQUNUX0FERFJFU1MgPSB7IHBhc3N0aHJvdWdoID0gdHJ1ZSB9CmxvYWRlci5lbnYuUlBDX1VSTCA9IHsgcGFzc3Rocm91Z2ggPSB0cnVlIH0KIyBOb3RlOiBSQVRMU19XSElURUxJU1RfQ09ORklHIGlzIHJlYWQgZnJvbSBjb250cmFjdCwgbm90IGZyb20gaG9zdCBlbnYKIyBUaGUgbGF1bmNoZXIgcmVhZHMgaXQgZnJvbSB0aGUgY29udHJhY3QgYW5kIHNldHMgaXQgaW50ZXJuYWxseQoKIyBNeVNRTCBjb25maWd1cmF0aW9uIChmaXhlZCBpbiBtYW5pZmVzdCBmb3Igc2VjdXJpdHkpCmxvYWRlci5lbnYuTVlTUUxfREFUQV9ESVIgPSAiL2FwcC93YWxsZXQvbXlzcWwtZGF0YSIKIyBOb3RlOiBNWVNRTF9ST09UX1BBU1NXT1JEIGlzIG5vdCBuZWVkZWQgYmVjYXVzZSBNeVNRTCB1c2VzIFguNTA5IGNlcnRpZmljYXRlIGF1dGhlbnRpY2F0aW9uIG9ubHkKCiMgRmlsZXN5c3RlbSBtb3VudHMKZnMubW91bnRzID0gWwogICMgR3JhbWluZSBydW50aW1lIGxpYnJhcmllcwogIHsgcGF0aCA9ICIvbGliIiwgdXJpID0gImZpbGU6e3sgZ3JhbWluZS5ydW50aW1lZGlyKCkgfX0iIH0sCiAgCiAgIyBTeXN0ZW0gbGlicmFyaWVzCiAgeyBwYXRoID0gIi91c3IvbGliIiwgdXJpID0gImZpbGU6L3Vzci9saWIiIH0sCiAgeyBwYXRoID0gIi91c3IvbG9jYWwvbGliIiwgdXJpID0gImZpbGU6L3Vzci9sb2NhbC9saWIiIH0sCiAgCiAgIyBCaW5hcmllcwogIHsgcGF0aCA9ICIvdXNyL2JpbiIsIHVyaSA9ICJmaWxlOi91c3IvYmluIiB9LAogIHsgcGF0aCA9ICIvdXNyL3NiaW4iLCB1cmkgPSAiZmlsZTovdXNyL3NiaW4iIH0sCiAgeyBwYXRoID0gIi91c3IvbG9jYWwvYmluIiwgdXJpID0gImZpbGU6L3Vzci9sb2NhbC9iaW4iIH0sCiAgeyBwYXRoID0gIi9iaW4iLCB1cmkgPSAiZmlsZTovYmluIiB9LAogIHsgcGF0aCA9ICIvc2JpbiIsIHVyaSA9ICJmaWxlOi9zYmluIiB9LAogIAogICMgU3lzdGVtIGNvbmZpZ3VyYXRpb24KICB7IHBhdGggPSAiL2V0YyIsIHVyaSA9ICJmaWxlOi9ldGMiIH0sCiAgCiAgIyBNeVNRTCBTU0wgY2VydGlmaWNhdGUgZGlyZWN0b3J5ICh3cml0YWJsZSBmb3IgUkEtVExTIGNlcnQgZ2VuZXJhdGlvbikKICB7IHBhdGggPSAiL3Zhci9saWIvbXlzcWwtc3NsIiwgdXJpID0gImZpbGU6L3Zhci9saWIvbXlzcWwtc3NsIiB9LAogIAogICMgTXlTUUwgcnVudGltZSBkaXJlY3RvcnkgKGZvciBzb2NrZXQgZmlsZSkKICB7IHBhdGggPSAiL3Zhci9ydW4vbXlzcWxkIiwgdXJpID0gImZpbGU6L3Zhci9ydW4vbXlzcWxkIiB9LAogIAogICMgRW5jcnlwdGVkIHN0b3JhZ2UgZm9yIE15U1FMIGRhdGEsIHByaXZhdGUga2V5cywgYW5kIHNlbnNpdGl2ZSBmaWxlcwogICMgTXlTUUwgZGF0YSBkaXJlY3RvcnkgTVVTVCBiZSBpbiBlbmNyeXB0ZWQgcGFydGl0aW9uIHRvIHByZXZlbnQgZGF0YSBsZWFrYWdlCiAgeyB0eXBlID0gImVuY3J5cHRlZCIsIHBhdGggPSAiL2FwcC93YWxsZXQiLCB1cmkgPSAiZmlsZTovYXBwL3dhbGxldCIgfSwKICAKICAjIFRlbXBvcmFyeSBkaXJlY3RvcnkKICB7IHR5cGUgPSAidG1wZnMiLCBwYXRoID0gIi90bXAiIH0sCl0KCiMgU0dYIGNvbmZpZ3VyYXRpb24Kc2d4LmRlYnVnID0gZmFsc2UKc2d4LmVuY2xhdmVfc2l6ZSA9ICI0RyIKc2d4Lm1heF90aHJlYWRzID0gNjQKc2d4LmVkbW1fZW5hYmxlID0gdHJ1ZQoKIyBFbmFibGUgRENBUCBhdHRlc3RhdGlvbgpzZ3gucmVtb3RlX2F0dGVzdGF0aW9uID0gImRjYXAiCgojIFRydXN0ZWQgZmlsZXMgKGludGVncml0eS1jaGVja2VkIGF0IGxvYWQgdGltZSkKIyBOb3RlOiBSQS1UTFMgbGlicmFyeSAobGlicmF0bHMtcXVvdGUtdmVyaWZ5LnNvKSBpcyBhdXRvbWF0aWNhbGx5IGhhbmRsZWQKIyBieSB0aGUgbWFuaWZlc3QgY29tcGlsZXIgd2hlbiBMRF9QUkVMT0FEIGlzIHNldApzZ3gudHJ1c3RlZF9maWxlcyA9IFsKICAjIEdyYW1pbmUgTGliT1MKICAiZmlsZTp7eyBncmFtaW5lLmxpYm9zIH19IiwKICAiZmlsZTp7eyBncmFtaW5lLnJ1bnRpbWVkaXIoKSB9fS8iLAogIAogICMgTGF1bmNoZXIgYmluYXJ5IChlbnRyeXBvaW50KQogICJmaWxlOnt7IGVudHJ5cG9pbnQgfX0iLAogIAogICMgTXlTUUwgc2VydmVyIGJpbmFyeSAodGFyZ2V0IG9mIGV4ZWN2ZSkKICAiZmlsZTovdXNyL3NiaW4vbXlzcWxkIiwKICAKICAjIFN5c3RlbSBsaWJyYXJpZXMgbmVlZGVkIGJ5IE15U1FMIGFuZCBsYXVuY2hlcgogICJmaWxlOi91c3IvbGliLyIsCiAgImZpbGU6L3Vzci9sb2NhbC9saWIvIiwKICAKICAjIE15U1FMIGNvbmZpZ3VyYXRpb24gYW5kIHN1cHBvcnQgZmlsZXMKICAiZmlsZTovZXRjL215c3FsLyIsCiAgImZpbGU6L3Vzci9zaGFyZS9teXNxbC8iLApdCgojIEFsbG93ZWQgZmlsZXMgKGNhbiBiZSBtb2RpZmllZCBhdCBydW50aW1lLCBub3QgaW50ZWdyaXR5LWNoZWNrZWQpCiMgTm90ZTogTXlTUUwgZGF0YSBkaXJlY3RvcnkgYW5kIGxvZ3MgYXJlIGluIGVuY3J5cHRlZCBwYXJ0aXRpb24gKC9hcHAvd2FsbGV0LykKIyBhbmQgZG8gbm90IG5lZWQgdG8gYmUgbGlzdGVkIGhlcmUgYXMgZW5jcnlwdGVkIG1vdW50cyBoYW5kbGUgdGhlaXIgb3duIGZpbGVzCnNneC5hbGxvd2VkX2ZpbGVzID0gWwogICMgU1NMIGNlcnRpZmljYXRlcyBkaXJlY3RvcnkgKHB1YmxpYyBjZXJ0aWZpY2F0ZXMgb25seSwgcHJpdmF0ZSBrZXlzIGluIGVuY3J5cHRlZCBwYXJ0aXRpb24pCiAgImZpbGU6L3Zhci9saWIvbXlzcWwtc3NsLyIsCiAgCiAgIyBNeVNRTCBydW50aW1lIGRpcmVjdG9yeSAoZm9yIHNvY2tldCBmaWxlKQogICJmaWxlOi92YXIvcnVuL215c3FsZC8iLAogIAogICMgVGVtcG9yYXJ5IGZpbGVzCiAgImZpbGU6L3RtcC8iLAogIAogICMgRE5TIHJlc29sdXRpb24gKHJlYWQtb25seSBzeXN0ZW0gZmlsZXMpCiAgImZpbGU6L2V0Yy9ob3N0cyIsCiAgImZpbGU6L2V0Yy9yZXNvbHYuY29uZiIsCiAgImZpbGU6L2V0Yy9uc3N3aXRjaC5jb25mIiwKICAKICAjIE5vdGU6IE15U1FMIGxvZ3MgYXJlIHN0b3JlZCBpbiBlbmNyeXB0ZWQgcGFydGl0aW9uIGF0IC9hcHAvd2FsbGV0L215c3FsLWxvZ3MKICAjIHRvIHByZXZlbnQgZGF0YSBsZWFrYWdlIHRocm91Z2ggbG9nIGZpbGVzCl0K' | base64 -d > /opt/mysql-ratls/mysql-ratls.manifest.template

# Configure MySQL for certificate-only authentication
# This configuration enforces SSL/TLS and prepares for RA-TLS certificates
RUN printf '\n# RA-TLS Configuration\n[mysqld]\n# Require secure transport (SSL/TLS)\nrequire_secure_transport = ON\n\n# SSL certificate paths (generated at runtime by RA-TLS)\n# Certificates are in normal directory, private key is in encrypted partition\nssl_ca = /var/lib/mysql-ssl/ca.pem\nssl_cert = /var/lib/mysql-ssl/server-cert.pem\n# Private key path is set via command line argument (from encrypted partition)\n\n# Require client certificates for authentication\nssl_mode = VERIFY_IDENTITY\n\n# Bind to all interfaces\nbind-address = 0.0.0.0\n\n# Skip name resolution for faster connections\nskip-name-resolve\n\n# Performance settings\nmax_connections = 100\ninnodb_buffer_pool_size = 256M\n\n# Data and log directories in encrypted partition to prevent data leakage\n# All sensitive data MUST be stored in encrypted partition\ndatadir = /app/wallet/mysql-data\nlog_error = /app/wallet/mysql-logs/error.log\ngeneral_log_file = /app/wallet/mysql-logs/general.log\nslow_query_log_file = /app/wallet/mysql-logs/slow.log\n\n' >> /etc/mysql/mysql.conf.d/mysqld.cnf

# Create necessary directories and build the Gramine manifest
# This generates the signed manifest so it's ready to run immediately
# Note: Directories in /app/wallet/ are created by the launcher inside the enclave
# (encrypted partition), so we only create non-encrypted directories here.
# No chown/chmod needed since we run as root in container.
RUN mkdir -p /var/lib/mysql-ssl /var/run/mysqld && \
    # Generate signing key for manifest
    mkdir -p /root/.config/gramine && \
    gramine-sgx-gen-private-key && \
    # Find RA-TLS library path
    RATLS_LIB_PATH=""; \
    for path in /usr/local/lib/x86_64-linux-gnu/libratls-quote-verify.so \
                /usr/local/lib/libratls-quote-verify.so \
                /usr/lib/x86_64-linux-gnu/libratls-quote-verify.so; do \
        if [ -f "$path" ]; then RATLS_LIB_PATH="$path"; break; fi; \
    done; \
    if [ -n "$RATLS_LIB_PATH" ]; then \
        export GRAMINE_LD_PRELOAD="file:${RATLS_LIB_PATH}"; \
        echo "Set GRAMINE_LD_PRELOAD=${GRAMINE_LD_PRELOAD}"; \
    fi; \
    # Generate manifest
    mkdir -p /var/lib/mysql && \
    cd /var/lib/mysql && \
    gramine-manifest \
        -Dentrypoint=/usr/local/bin/mysql-ratls-launcher \
        -Dlog_level=error \
        /opt/mysql-ratls/mysql-ratls.manifest.template \
        /var/lib/mysql/mysql-ratls.manifest && \
    # Sign manifest
    gramine-sgx-sign \
        --manifest /var/lib/mysql/mysql-ratls.manifest \
        --output /var/lib/mysql/mysql-ratls.manifest.sgx && \
    # Verify files were created
    ls -la /var/lib/mysql/mysql-ratls.manifest* && \
    # Copy manifests to /opt/mysql-ratls for reference
    cp /var/lib/mysql/mysql-ratls.manifest* /opt/mysql-ratls/

# Clean up build artifacts (keep only what's needed at runtime)
RUN rm -rf /opt/mysql-ratls/launcher/*.c \
    /opt/mysql-ratls/launcher/*.h \
    /opt/mysql-ratls/launcher/*.o \
    /opt/mysql-ratls/launcher/mysql-ratls-launcher

# Note: All RA-TLS environment variables are configured in the Gramine manifest
# (loader.env.*) and are NOT set here because host environment variables are
# isolated from the SGX enclave. The manifest directly sets:
# - RA_TLS_CERT_ALGORITHM=secp256k1
# - RATLS_ENABLE_VERIFY=1
# - RATLS_REQUIRE_PEER_CERT=1
# - RATLS_CERT_PATH=/var/lib/mysql-ssl/server-cert.pem
# - RATLS_KEY_PATH=/app/wallet/mysql-keys/server-key.pem
# - MYSQL_DATA_DIR=/app/wallet/mysql-data

# Expose MySQL port
EXPOSE 3306

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD mysqladmin ping -h localhost --silent || exit 1

# Set working directory to encrypted MySQL data directory
WORKDIR /app/wallet/mysql-data

# The entrypoint runs the base image's entrypoint first (starts aesmd, PCCS, etc.)
# Then runs gramine-sgx with the pre-compiled manifest to start the launcher in SGX enclave
# The launcher (inside enclave) will then execve() to mysqld
# Note: Use full path to manifest because WORKDIR is /app/wallet/mysql-data (encrypted partition)
ENTRYPOINT ["/usr/local/bin/entrypoint.sh", "gramine-sgx", "/var/lib/mysql/mysql-ratls"]
CMD []
