# MySQL 8 with RA-TLS (Remote Attestation TLS) Support in SGX Enclave
#
# This is a SELF-CONTAINED Dockerfile - no external files are needed.
# All source code (C launcher, manifest template) is embedded as base64.
#
# NOTE: This Dockerfile uses base64 encoding for embedded files to ensure
# compatibility with both legacy Docker builder and BuildKit.
# (Heredoc syntax doesn't work correctly with the legacy builder)
#
# Architecture:
# - A C launcher program runs inside the SGX enclave
# - The launcher reads whitelist from smart contract (if configured)
# - The launcher uses execve() to replace itself with mysqld (same enclave)
# - RA-TLS is injected via LD_PRELOAD configured in the Gramine manifest
# - DCAP attestation is enabled for remote verification
#
# Features:
# - Mutual RA-TLS authentication (both client and server must be SGX-based)
# - Certificate-only MySQL authentication (no passwords)
# - Certificates generated at startup from SGX quotes using secp256k1 curve
# - Optional whitelist from smart contract (via CONTRACT_ADDRESS env var)
# - Pre-compiled Gramine manifest for immediate SGX execution
#
# Environment Variables:
#   CONTRACT_ADDRESS - Smart contract address to read whitelist from (optional)
#   RPC_URL - Ethereum RPC endpoint URL (required if CONTRACT_ADDRESS is set)
#
# Usage:
#   docker build -t mysql-ratls .
#   docker run -d \
#     --device=/dev/sgx_enclave \
#     --device=/dev/sgx_provision \
#     -e PCCS_API_KEY=your_api_key \
#     -e CONTRACT_ADDRESS=0x... \
#     -e RPC_URL=https://... \
#     -p 3306:3306 \
#     mysql-ratls
#

ARG BASE_IMAGE=ghcr.io/mccoysc/gramine-web3-wallet-docker:latest
FROM ${BASE_IMAGE}

LABEL org.opencontainers.image.description="MySQL 8 with RA-TLS (Remote Attestation TLS) support for SGX-based mutual authentication"
LABEL org.opencontainers.image.licenses=GPL-2.0

# Avoid interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Prevent services from starting during package installation
# This is standard practice for Docker builds - we don't want MySQL to start during apt-get install
RUN printf '#!/bin/sh\nexit 101\n' > /usr/sbin/policy-rc.d && \
    chmod +x /usr/sbin/policy-rc.d

# Install MySQL 8 server and development dependencies for launcher compilation
RUN apt-get update && apt-get install -y --no-install-recommends \
    mysql-server \
    mysql-client \
    libcurl4-openssl-dev \
    && rm -rf /var/lib/apt/lists/*

# Clean up default MySQL data directory (we use encrypted partition at runtime)
# and remove policy-rc.d since we're done with apt installations
RUN rm -rf /var/lib/mysql/* && rm -f /usr/sbin/policy-rc.d

# Create directories for MySQL data and SSL certificates
RUN mkdir -p /var/lib/mysql /var/lib/mysql-ssl /var/run/mysqld \
    && chown -R mysql:mysql /var/lib/mysql /var/lib/mysql-ssl /var/run/mysqld \
    && chmod 755 /var/run/mysqld

# Create launcher directory
RUN mkdir -p /opt/mysql-ratls/launcher

# Download cJSON library (MIT licensed JSON parser)
RUN curl -fsSL https://raw.githubusercontent.com/DaveGamble/cJSON/v1.7.18/cJSON.c \
      -o /opt/mysql-ratls/launcher/cJSON.c && \
    curl -fsSL https://raw.githubusercontent.com/DaveGamble/cJSON/v1.7.18/cJSON.h \
      -o /opt/mysql-ratls/launcher/cJSON.h

# Embed the C launcher source code (base64 encoded for legacy Docker builder compatibility)
# To update: base64 -w0 mysql_ratls_launcher.c > mysql_ratls_launcher.c.b64
RUN echo 'LyoKICogTXlTUUwgUkEtVExTIExhdW5jaGVyCiAqIAogKiBUaGlzIHByb2dyYW0gcnVucyBpbnNpZGUgYSBHcmFtaW5lIFNHWCBlbmNsYXZlIGFuZDoKICogMS4gUmVhZHMgd2hpdGVsaXN0IGNvbmZpZ3VyYXRpb24gZnJvbSBhIHNtYXJ0IGNvbnRyYWN0IChpZiBDT05UUkFDVF9BRERSRVNTIGlzIHNldCkKICogMi4gU2V0cyB1cCBSQS1UTFMgZW52aXJvbm1lbnQgdmFyaWFibGVzCiAqIDMuIFVzZXMgZXhlY3ZlKCkgdG8gcmVwbGFjZSBpdHNlbGYgd2l0aCBteXNxbGQKICoKICogVGhlIGxhdW5jaGVyIGF2b2lkcyBjcmVhdGluZyBjaGlsZCBwcm9jZXNzZXMgaW4gdGhlIGVuY2xhdmUgYnkgdXNpbmcgZXhlY3ZlKCkKICogdG8gZGlyZWN0bHkgcmVwbGFjZSB0aGUgY3VycmVudCBwcm9jZXNzIHdpdGggbXlzcWxkLgogKi8KCiNkZWZpbmUgX0dOVV9TT1VSQ0UKI2luY2x1ZGUgPHN0ZGlvLmg+CiNpbmNsdWRlIDxzdGRsaWIuaD4KI2luY2x1ZGUgPHN0cmluZy5oPgojaW5jbHVkZSA8dW5pc3RkLmg+CiNpbmNsdWRlIDxlcnJuby5oPgojaW5jbHVkZSA8c3lzL3N0YXQuaD4KI2luY2x1ZGUgPHN5cy90eXBlcy5oPgojaW5jbHVkZSA8Y3VybC9jdXJsLmg+CgojaW5jbHVkZSAiY0pTT04uaCIKCi8qIENvbmZpZ3VyYXRpb24gY29uc3RhbnRzICovCiNkZWZpbmUgTVlTUUxEX1BBVEggIi91c3Ivc2Jpbi9teXNxbGQiCiNkZWZpbmUgREVGQVVMVF9DRVJUX1BBVEggIi92YXIvbGliL215c3FsLXNzbC9zZXJ2ZXItY2VydC5wZW0iCiNkZWZpbmUgREVGQVVMVF9LRVlfUEFUSCAiL2FwcC93YWxsZXQvbXlzcWwta2V5cy9zZXJ2ZXIta2V5LnBlbSIKI2RlZmluZSBERUZBVUxUX0NBX1BBVEggIi92YXIvbGliL215c3FsLXNzbC9jYS5wZW0iCiNkZWZpbmUgREVGQVVMVF9EQVRBX0RJUiAiL2FwcC93YWxsZXQvbXlzcWwtZGF0YSIKI2RlZmluZSBJTklUX1NFTlRJTkVMX0ZJTEUgIi5teXNxbF9pbml0aWFsaXplZCIKI2RlZmluZSBJTklUX1NRTF9GSUxFICJpbml0X3VzZXJzLnNxbCIKCi8qIGdldFNHWENvbmZpZygpIGZ1bmN0aW9uIHNlbGVjdG9yOiBrZWNjYWsyNTYoImdldFNHWENvbmZpZygpIilbMDo0XSAqLwojZGVmaW5lIEdFVF9TR1hfQ09ORklHX1NFTEVDVE9SICIweDA2MmUyMjUyIgoKLyogTWF4aW11bSBzaXplcyAqLwojZGVmaW5lIE1BWF9VUkxfTEVOIDIwNDgKI2RlZmluZSBNQVhfUkVTUE9OU0VfTEVOICgxMDI0ICogMTAyNCkgIC8qIDFNQiBtYXggcmVzcG9uc2UgKi8KI2RlZmluZSBNQVhfUEFUSF9MRU4gNDA5NgoKLyogU3RydWN0dXJlIHRvIGhvbGQgY3VybCByZXNwb25zZSAqLwpzdHJ1Y3QgY3VybF9yZXNwb25zZSB7CiAgICBjaGFyICpkYXRhOwogICAgc2l6ZV90IHNpemU7Cn07CgovKiBDdXJsIHdyaXRlIGNhbGxiYWNrICovCnN0YXRpYyBzaXplX3Qgd3JpdGVfY2FsbGJhY2sodm9pZCAqY29udGVudHMsIHNpemVfdCBzaXplLCBzaXplX3Qgbm1lbWIsIHZvaWQgKnVzZXJwKSB7CiAgICBzaXplX3QgcmVhbHNpemUgPSBzaXplICogbm1lbWI7CiAgICBzdHJ1Y3QgY3VybF9yZXNwb25zZSAqcmVzcCA9IChzdHJ1Y3QgY3VybF9yZXNwb25zZSAqKXVzZXJwOwogICAgCiAgICBpZiAocmVzcC0+c2l6ZSArIHJlYWxzaXplID4gTUFYX1JFU1BPTlNFX0xFTikgewogICAgICAgIGZwcmludGYoc3RkZXJyLCAiW0xhdW5jaGVyXSBSZXNwb25zZSB0b28gbGFyZ2UsIHRydW5jYXRpbmdcbiIpOwogICAgICAgIHJldHVybiAwOwogICAgfQogICAgCiAgICBjaGFyICpwdHIgPSByZWFsbG9jKHJlc3AtPmRhdGEsIHJlc3AtPnNpemUgKyByZWFsc2l6ZSArIDEpOwogICAgaWYgKCFwdHIpIHsKICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltMYXVuY2hlcl0gT3V0IG9mIG1lbW9yeVxuIik7CiAgICAgICAgcmV0dXJuIDA7CiAgICB9CiAgICAKICAgIHJlc3AtPmRhdGEgPSBwdHI7CiAgICBtZW1jcHkoJihyZXNwLT5kYXRhW3Jlc3AtPnNpemVdKSwgY29udGVudHMsIHJlYWxzaXplKTsKICAgIHJlc3AtPnNpemUgKz0gcmVhbHNpemU7CiAgICByZXNwLT5kYXRhW3Jlc3AtPnNpemVdID0gJ1wwJzsKICAgIAogICAgcmV0dXJuIHJlYWxzaXplOwp9CgovKiBDcmVhdGUgZGlyZWN0b3J5IHJlY3Vyc2l2ZWx5ICovCnN0YXRpYyBpbnQgbWtkaXJfcChjb25zdCBjaGFyICpwYXRoKSB7CiAgICBjaGFyIHRtcFtNQVhfUEFUSF9MRU5dOwogICAgY2hhciAqcCA9IE5VTEw7CiAgICBzaXplX3QgbGVuOwogICAgCiAgICBzbnByaW50Zih0bXAsIHNpemVvZih0bXApLCAiJXMiLCBwYXRoKTsKICAgIGxlbiA9IHN0cmxlbih0bXApOwogICAgaWYgKHRtcFtsZW4gLSAxXSA9PSAnLycpCiAgICAgICAgdG1wW2xlbiAtIDFdID0gJ1wwJzsKICAgIAogICAgZm9yIChwID0gdG1wICsgMTsgKnA7IHArKykgewogICAgICAgIGlmICgqcCA9PSAnLycpIHsKICAgICAgICAgICAgKnAgPSAnXDAnOwogICAgICAgICAgICBpZiAobWtkaXIodG1wLCAwNzU1KSAhPSAwICYmIGVycm5vICE9IEVFWElTVCkgewogICAgICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgICAgICB9CiAgICAgICAgICAgICpwID0gJy8nOwogICAgICAgIH0KICAgIH0KICAgIAogICAgaWYgKG1rZGlyKHRtcCwgMDc1NSkgIT0gMCAmJiBlcnJubyAhPSBFRVhJU1QpIHsKICAgICAgICByZXR1cm4gLTE7CiAgICB9CiAgICAKICAgIHJldHVybiAwOwp9CgovKiBHZXQgZGlyZWN0b3J5IGZyb20gcGF0aCAqLwpzdGF0aWMgdm9pZCBnZXRfZGlybmFtZShjb25zdCBjaGFyICpwYXRoLCBjaGFyICpkaXIsIHNpemVfdCBkaXJfc2l6ZSkgewogICAgc3RybmNweShkaXIsIHBhdGgsIGRpcl9zaXplIC0gMSk7CiAgICBkaXJbZGlyX3NpemUgLSAxXSA9ICdcMCc7CiAgICAKICAgIGNoYXIgKmxhc3Rfc2xhc2ggPSBzdHJyY2hyKGRpciwgJy8nKTsKICAgIGlmIChsYXN0X3NsYXNoKSB7CiAgICAgICAgKmxhc3Rfc2xhc2ggPSAnXDAnOwogICAgfQp9CgovKiBDaGVjayBpZiBmaWxlIGV4aXN0cyAqLwpzdGF0aWMgaW50IGZpbGVfZXhpc3RzKGNvbnN0IGNoYXIgKnBhdGgpIHsKICAgIHN0cnVjdCBzdGF0IHN0OwogICAgcmV0dXJuIHN0YXQocGF0aCwgJnN0KSA9PSAwOwp9CgovKiBDaGVjayBpZiBNeVNRTCBpcyBpbml0aWFsaXplZCAoc2VudGluZWwgZmlsZSBleGlzdHMpICovCnN0YXRpYyBpbnQgaXNfbXlzcWxfaW5pdGlhbGl6ZWQoY29uc3QgY2hhciAqZGF0YV9kaXIpIHsKICAgIGNoYXIgc2VudGluZWxfcGF0aFtNQVhfUEFUSF9MRU5dOwogICAgc25wcmludGYoc2VudGluZWxfcGF0aCwgc2l6ZW9mKHNlbnRpbmVsX3BhdGgpLCAiJXMvJXMiLCBkYXRhX2RpciwgSU5JVF9TRU5USU5FTF9GSUxFKTsKICAgIHJldHVybiBmaWxlX2V4aXN0cyhzZW50aW5lbF9wYXRoKTsKfQoKLyogQ3JlYXRlIHRoZSBpbml0aWFsaXphdGlvbiBTUUwgZmlsZSBmb3IgZmlyc3QgYm9vdCAqLwpzdGF0aWMgaW50IGNyZWF0ZV9pbml0X3NxbChjb25zdCBjaGFyICpkYXRhX2RpciwgY2hhciAqaW5pdF9zcWxfcGF0aCwgc2l6ZV90IHBhdGhfc2l6ZSkgewogICAgc25wcmludGYoaW5pdF9zcWxfcGF0aCwgcGF0aF9zaXplLCAiJXMvJXMiLCBkYXRhX2RpciwgSU5JVF9TUUxfRklMRSk7CiAgICAKICAgIEZJTEUgKmYgPSBmb3Blbihpbml0X3NxbF9wYXRoLCAidyIpOwogICAgaWYgKCFmKSB7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbTGF1bmNoZXJdIEZhaWxlZCB0byBjcmVhdGUgaW5pdCBTUUwgZmlsZTogJXNcbiIsIHN0cmVycm9yKGVycm5vKSk7CiAgICAgICAgcmV0dXJuIC0xOwogICAgfQogICAgCiAgICAvKiBXcml0ZSBpZGVtcG90ZW50IFNRTCB0byBjcmVhdGUgWC41MDktb25seSB1c2VycyAqLwogICAgZnByaW50ZihmLCAiLS0gTXlTUUwgUkEtVExTIFVzZXIgSW5pdGlhbGl6YXRpb25cbiIpOwogICAgZnByaW50ZihmLCAiLS0gVGhpcyBmaWxlIGlzIGV4ZWN1dGVkIG9uIGZpcnN0IGJvb3QgaW5zaWRlIHRoZSBTR1ggZW5jbGF2ZVxuIik7CiAgICBmcHJpbnRmKGYsICItLSBVc2VycyBhcmUgY29uZmlndXJlZCB3aXRoIFJFUVVJUkUgWDUwOSAoY2VydGlmaWNhdGUtb25seSBhdXRoZW50aWNhdGlvbilcbiIpOwogICAgZnByaW50ZihmLCAiLS0gUkEtVExTIGhhbmRsZXMgdGhlIGFjdHVhbCBTR1ggYXR0ZXN0YXRpb24gdmVyaWZpY2F0aW9uXG5cbiIpOwogICAgCiAgICAKICAgIC8qIENyZWF0ZSBhcHBsaWNhdGlvbiB1c2VyIHdpdGggWDUwOSByZXF1aXJlbWVudCAqLwogICAgZnByaW50ZihmLCAiLS0gQ3JlYXRlIGFwcGxpY2F0aW9uIHVzZXIgdGhhdCByZXF1aXJlcyBYLjUwOSBjZXJ0aWZpY2F0ZVxuIik7CiAgICBmcHJpbnRmKGYsICJDUkVBVEUgVVNFUiBJRiBOT1QgRVhJU1RTICdhcHAnQCclJScgSURFTlRJRklFRCBCWSAnJyBSRVFVSVJFIFg1MDk7XG4iKTsKICAgIGZwcmludGYoZiwgIkdSQU5UIEFMTCBQUklWSUxFR0VTIE9OICouKiBUTyAnYXBwJ0AnJSUnIFdJVEggR1JBTlQgT1BUSU9OO1xuXG4iKTsKICAgIAogICAgLyogQ3JlYXRlIGEgcmVhZC1vbmx5IHVzZXIgd2l0aCBYNTA5IHJlcXVpcmVtZW50ICovCiAgICBmcHJpbnRmKGYsICItLSBDcmVhdGUgcmVhZC1vbmx5IHVzZXIgdGhhdCByZXF1aXJlcyBYLjUwOSBjZXJ0aWZpY2F0ZVxuIik7CiAgICBmcHJpbnRmKGYsICJDUkVBVEUgVVNFUiBJRiBOT1QgRVhJU1RTICdyZWFkZXInQCclJScgSURFTlRJRklFRCBCWSAnJyBSRVFVSVJFIFg1MDk7XG4iKTsKICAgIGZwcmludGYoZiwgIkdSQU5UIFNFTEVDVCBPTiAqLiogVE8gJ3JlYWRlcidAJyUlJztcblxuIik7CiAgICAKICAgIGZwcmludGYoZiwgIkZMVVNIIFBSSVZJTEVHRVM7XG4iKTsKICAgIAogICAgZmNsb3NlKGYpOwogICAgCiAgICBwcmludGYoIltMYXVuY2hlcl0gQ3JlYXRlZCBpbml0IFNRTCBmaWxlOiAlc1xuIiwgaW5pdF9zcWxfcGF0aCk7CiAgICByZXR1cm4gMDsKfQoKLyogQ3JlYXRlIHRoZSBzZW50aW5lbCBmaWxlIHRvIG1hcmsgTXlTUUwgYXMgaW5pdGlhbGl6ZWQgKi8Kc3RhdGljIGludCBjcmVhdGVfc2VudGluZWxfZmlsZShjb25zdCBjaGFyICpkYXRhX2RpcikgewogICAgY2hhciBzZW50aW5lbF9wYXRoW01BWF9QQVRIX0xFTl07CiAgICBzbnByaW50ZihzZW50aW5lbF9wYXRoLCBzaXplb2Yoc2VudGluZWxfcGF0aCksICIlcy8lcyIsIGRhdGFfZGlyLCBJTklUX1NFTlRJTkVMX0ZJTEUpOwogICAgCiAgICBGSUxFICpmID0gZm9wZW4oc2VudGluZWxfcGF0aCwgInciKTsKICAgIGlmICghZikgewogICAgICAgIGZwcmludGYoc3RkZXJyLCAiW0xhdW5jaGVyXSBGYWlsZWQgdG8gY3JlYXRlIHNlbnRpbmVsIGZpbGU6ICVzXG4iLCBzdHJlcnJvcihlcnJubykpOwogICAgICAgIHJldHVybiAtMTsKICAgIH0KICAgIAogICAgZnByaW50ZihmLCAiTXlTUUwgaW5pdGlhbGl6ZWQgd2l0aCBSQS1UTFMgWC41MDkgdXNlcnNcbiIpOwogICAgZmNsb3NlKGYpOwogICAgCiAgICBwcmludGYoIltMYXVuY2hlcl0gQ3JlYXRlZCBzZW50aW5lbCBmaWxlOiAlc1xuIiwgc2VudGluZWxfcGF0aCk7CiAgICByZXR1cm4gMDsKfQoKLyogSGV4IGNoYXJhY3RlciB0byBpbnRlZ2VyICovCnN0YXRpYyBpbnQgaGV4X2NoYXJfdG9faW50KGNoYXIgYykgewogICAgaWYgKGMgPj0gJzAnICYmIGMgPD0gJzknKSByZXR1cm4gYyAtICcwJzsKICAgIGlmIChjID49ICdhJyAmJiBjIDw9ICdmJykgcmV0dXJuIGMgLSAnYScgKyAxMDsKICAgIGlmIChjID49ICdBJyAmJiBjIDw9ICdGJykgcmV0dXJuIGMgLSAnQScgKyAxMDsKICAgIHJldHVybiAtMTsKfQoKLyogRGVjb2RlIGhleCBzdHJpbmcgdG8gYnl0ZXMgKi8Kc3RhdGljIGludCBoZXhfZGVjb2RlKGNvbnN0IGNoYXIgKmhleCwgdW5zaWduZWQgY2hhciAqb3V0LCBzaXplX3Qgb3V0X2xlbikgewogICAgc2l6ZV90IGhleF9sZW4gPSBzdHJsZW4oaGV4KTsKICAgIAogICAgLyogU2tpcCAweCBwcmVmaXggaWYgcHJlc2VudCAqLwogICAgaWYgKGhleF9sZW4gPj0gMiAmJiBoZXhbMF0gPT0gJzAnICYmIChoZXhbMV0gPT0gJ3gnIHx8IGhleFsxXSA9PSAnWCcpKSB7CiAgICAgICAgaGV4ICs9IDI7CiAgICAgICAgaGV4X2xlbiAtPSAyOwogICAgfQogICAgCiAgICBpZiAoaGV4X2xlbiAlIDIgIT0gMCB8fCBoZXhfbGVuIC8gMiA+IG91dF9sZW4pIHsKICAgICAgICByZXR1cm4gLTE7CiAgICB9CiAgICAKICAgIGZvciAoc2l6ZV90IGkgPSAwOyBpIDwgaGV4X2xlbiAvIDI7IGkrKykgewogICAgICAgIGludCBoaWdoID0gaGV4X2NoYXJfdG9faW50KGhleFtpICogMl0pOwogICAgICAgIGludCBsb3cgPSBoZXhfY2hhcl90b19pbnQoaGV4W2kgKiAyICsgMV0pOwogICAgICAgIGlmIChoaWdoIDwgMCB8fCBsb3cgPCAwKSByZXR1cm4gLTE7CiAgICAgICAgb3V0W2ldID0gKGhpZ2ggPDwgNCkgfCBsb3c7CiAgICB9CiAgICAKICAgIHJldHVybiBoZXhfbGVuIC8gMjsKfQoKLyogRGVjb2RlIEFCSS1lbmNvZGVkIHN0cmluZyBmcm9tIGV0aF9jYWxsIHJlc3VsdCAqLwpzdGF0aWMgY2hhciAqZGVjb2RlX2FiaV9zdHJpbmcoY29uc3QgY2hhciAqaGV4X3Jlc3VsdCkgewogICAgdW5zaWduZWQgY2hhciAqYnl0ZXMgPSBOVUxMOwogICAgY2hhciAqcmVzdWx0ID0gTlVMTDsKICAgIAogICAgLyogU2tpcCAweCBwcmVmaXggKi8KICAgIGlmIChzdHJsZW4oaGV4X3Jlc3VsdCkgPCAyKSByZXR1cm4gTlVMTDsKICAgIGNvbnN0IGNoYXIgKmhleCA9IGhleF9yZXN1bHQ7CiAgICBpZiAoaGV4WzBdID09ICcwJyAmJiAoaGV4WzFdID09ICd4JyB8fCBoZXhbMV0gPT0gJ1gnKSkgewogICAgICAgIGhleCArPSAyOwogICAgfQogICAgCiAgICBzaXplX3QgaGV4X2xlbiA9IHN0cmxlbihoZXgpOwogICAgaWYgKGhleF9sZW4gPCAxMjgpIHsgIC8qIE1pbmltdW06IG9mZnNldCAoNjQpICsgbGVuZ3RoICg2NCkgKi8KICAgICAgICByZXR1cm4gTlVMTDsKICAgIH0KICAgIAogICAgLyogQWxsb2NhdGUgYnVmZmVyIGZvciBkZWNvZGVkIGJ5dGVzICovCiAgICBzaXplX3QgYnl0ZXNfbGVuID0gaGV4X2xlbiAvIDI7CiAgICBieXRlcyA9IG1hbGxvYyhieXRlc19sZW4pOwogICAgaWYgKCFieXRlcykgcmV0dXJuIE5VTEw7CiAgICAKICAgIGlmIChoZXhfZGVjb2RlKGhleF9yZXN1bHQsIGJ5dGVzLCBieXRlc19sZW4pIDwgMCkgewogICAgICAgIGZyZWUoYnl0ZXMpOwogICAgICAgIHJldHVybiBOVUxMOwogICAgfQogICAgCiAgICAvKiBGaXJzdCAzMiBieXRlczogb2Zmc2V0IHRvIHN0cmluZyBkYXRhIChzaG91bGQgYmUgMHgyMCA9IDMyKSAqLwogICAgLyogTmV4dCAzMiBieXRlcyBhdCBvZmZzZXQ6IHN0cmluZyBsZW5ndGggKi8KICAgIC8qIEZvbGxvd2luZyBieXRlczogc3RyaW5nIGRhdGEgKi8KICAgIAogICAgLyogUmVhZCBvZmZzZXQgKGJpZy1lbmRpYW4sIGxhc3QgNCBieXRlcyBvZiBmaXJzdCAzMikgKi8KICAgIHNpemVfdCBvZmZzZXQgPSAwOwogICAgZm9yIChpbnQgaSA9IDI4OyBpIDwgMzI7IGkrKykgewogICAgICAgIG9mZnNldCA9IChvZmZzZXQgPDwgOCkgfCBieXRlc1tpXTsKICAgIH0KICAgIAogICAgaWYgKG9mZnNldCArIDMyID4gYnl0ZXNfbGVuKSB7CiAgICAgICAgZnJlZShieXRlcyk7CiAgICAgICAgcmV0dXJuIE5VTEw7CiAgICB9CiAgICAKICAgIC8qIFJlYWQgc3RyaW5nIGxlbmd0aCBhdCBvZmZzZXQgKi8KICAgIHNpemVfdCBzdHJfbGVuID0gMDsKICAgIGZvciAoaW50IGkgPSAyODsgaSA8IDMyOyBpKyspIHsKICAgICAgICBzdHJfbGVuID0gKHN0cl9sZW4gPDwgOCkgfCBieXRlc1tvZmZzZXQgKyBpXTsKICAgIH0KICAgIAogICAgaWYgKG9mZnNldCArIDMyICsgc3RyX2xlbiA+IGJ5dGVzX2xlbikgewogICAgICAgIGZyZWUoYnl0ZXMpOwogICAgICAgIHJldHVybiBOVUxMOwogICAgfQogICAgCiAgICAvKiBFeHRyYWN0IHN0cmluZyAqLwogICAgcmVzdWx0ID0gbWFsbG9jKHN0cl9sZW4gKyAxKTsKICAgIGlmICghcmVzdWx0KSB7CiAgICAgICAgZnJlZShieXRlcyk7CiAgICAgICAgcmV0dXJuIE5VTEw7CiAgICB9CiAgICAKICAgIG1lbWNweShyZXN1bHQsIGJ5dGVzICsgb2Zmc2V0ICsgMzIsIHN0cl9sZW4pOwogICAgcmVzdWx0W3N0cl9sZW5dID0gJ1wwJzsKICAgIAogICAgZnJlZShieXRlcyk7CiAgICByZXR1cm4gcmVzdWx0Owp9CgovKiBDYWxsIEV0aGVyZXVtIEpTT04tUlBDIGV0aF9jYWxsICovCnN0YXRpYyBjaGFyICpldGhfY2FsbChjb25zdCBjaGFyICpycGNfdXJsLCBjb25zdCBjaGFyICpjb250cmFjdF9hZGRyZXNzLCBjb25zdCBjaGFyICpkYXRhKSB7CiAgICBDVVJMICpjdXJsOwogICAgQ1VSTGNvZGUgcmVzOwogICAgc3RydWN0IGN1cmxfcmVzcG9uc2UgcmVzcG9uc2UgPSB7MH07CiAgICBjaGFyICpyZXN1bHQgPSBOVUxMOwogICAgY2hhciBwb3N0X2RhdGFbTUFYX1VSTF9MRU5dOwogICAgc3RydWN0IGN1cmxfc2xpc3QgKmhlYWRlcnMgPSBOVUxMOwogICAgCiAgICAvKiBCdWlsZCBKU09OLVJQQyByZXF1ZXN0ICovCiAgICBzbnByaW50Zihwb3N0X2RhdGEsIHNpemVvZihwb3N0X2RhdGEpLAogICAgICAgICJ7XCJqc29ucnBjXCI6XCIyLjBcIixcImlkXCI6MSxcIm1ldGhvZFwiOlwiZXRoX2NhbGxcIiwiCiAgICAgICAgIlwicGFyYW1zXCI6W3tcInRvXCI6XCIlc1wiLFwiZGF0YVwiOlwiJXNcIn0sXCJsYXRlc3RcIl19IiwKICAgICAgICBjb250cmFjdF9hZGRyZXNzLCBkYXRhKTsKICAgIAogICAgY3VybCA9IGN1cmxfZWFzeV9pbml0KCk7CiAgICBpZiAoIWN1cmwpIHsKICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltMYXVuY2hlcl0gRmFpbGVkIHRvIGluaXRpYWxpemUgY3VybFxuIik7CiAgICAgICAgcmV0dXJuIE5VTEw7CiAgICB9CiAgICAKICAgIHJlc3BvbnNlLmRhdGEgPSBtYWxsb2MoMSk7CiAgICBpZiAoIXJlc3BvbnNlLmRhdGEpIHsKICAgICAgICBjdXJsX2Vhc3lfY2xlYW51cChjdXJsKTsKICAgICAgICByZXR1cm4gTlVMTDsKICAgIH0KICAgIHJlc3BvbnNlLmRhdGFbMF0gPSAnXDAnOwogICAgcmVzcG9uc2Uuc2l6ZSA9IDA7CiAgICAKICAgIGhlYWRlcnMgPSBjdXJsX3NsaXN0X2FwcGVuZChoZWFkZXJzLCAiQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qc29uIik7CiAgICAKICAgIGN1cmxfZWFzeV9zZXRvcHQoY3VybCwgQ1VSTE9QVF9VUkwsIHJwY191cmwpOwogICAgY3VybF9lYXN5X3NldG9wdChjdXJsLCBDVVJMT1BUX1BPU1RGSUVMRFMsIHBvc3RfZGF0YSk7CiAgICBjdXJsX2Vhc3lfc2V0b3B0KGN1cmwsIENVUkxPUFRfSFRUUEhFQURFUiwgaGVhZGVycyk7CiAgICBjdXJsX2Vhc3lfc2V0b3B0KGN1cmwsIENVUkxPUFRfV1JJVEVGVU5DVElPTiwgd3JpdGVfY2FsbGJhY2spOwogICAgY3VybF9lYXN5X3NldG9wdChjdXJsLCBDVVJMT1BUX1dSSVRFREFUQSwgJnJlc3BvbnNlKTsKICAgIGN1cmxfZWFzeV9zZXRvcHQoY3VybCwgQ1VSTE9QVF9USU1FT1VULCAzMEwpOwogICAgY3VybF9lYXN5X3NldG9wdChjdXJsLCBDVVJMT1BUX0NPTk5FQ1RUSU1FT1VULCAxMEwpOwogICAgCiAgICByZXMgPSBjdXJsX2Vhc3lfcGVyZm9ybShjdXJsKTsKICAgIAogICAgaWYgKHJlcyAhPSBDVVJMRV9PSykgewogICAgICAgIGZwcmludGYoc3RkZXJyLCAiW0xhdW5jaGVyXSBjdXJsIGVycm9yOiAlc1xuIiwgY3VybF9lYXN5X3N0cmVycm9yKHJlcykpOwogICAgICAgIGdvdG8gY2xlYW51cDsKICAgIH0KICAgIAogICAgLyogUGFyc2UgSlNPTiByZXNwb25zZSAqLwogICAgY0pTT04gKmpzb24gPSBjSlNPTl9QYXJzZShyZXNwb25zZS5kYXRhKTsKICAgIGlmICghanNvbikgewogICAgICAgIGZwcmludGYoc3RkZXJyLCAiW0xhdW5jaGVyXSBGYWlsZWQgdG8gcGFyc2UgSlNPTiByZXNwb25zZVxuIik7CiAgICAgICAgZ290byBjbGVhbnVwOwogICAgfQogICAgCiAgICAvKiBDaGVjayBmb3IgZXJyb3IgKi8KICAgIGNKU09OICplcnJvciA9IGNKU09OX0dldE9iamVjdEl0ZW0oanNvbiwgImVycm9yIik7CiAgICBpZiAoZXJyb3IpIHsKICAgICAgICBjSlNPTiAqbWVzc2FnZSA9IGNKU09OX0dldE9iamVjdEl0ZW0oZXJyb3IsICJtZXNzYWdlIik7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbTGF1bmNoZXJdIFJQQyBlcnJvcjogJXNcbiIsIAogICAgICAgICAgICBtZXNzYWdlID8gbWVzc2FnZS0+dmFsdWVzdHJpbmcgOiAidW5rbm93biIpOwogICAgICAgIGNKU09OX0RlbGV0ZShqc29uKTsKICAgICAgICBnb3RvIGNsZWFudXA7CiAgICB9CiAgICAKICAgIC8qIEdldCByZXN1bHQgKi8KICAgIGNKU09OICpyZXN1bHRfanNvbiA9IGNKU09OX0dldE9iamVjdEl0ZW0oanNvbiwgInJlc3VsdCIpOwogICAgaWYgKHJlc3VsdF9qc29uICYmIHJlc3VsdF9qc29uLT52YWx1ZXN0cmluZykgewogICAgICAgIHJlc3VsdCA9IHN0cmR1cChyZXN1bHRfanNvbi0+dmFsdWVzdHJpbmcpOwogICAgfQogICAgCiAgICBjSlNPTl9EZWxldGUoanNvbik7CiAgICAKY2xlYW51cDoKICAgIGN1cmxfc2xpc3RfZnJlZV9hbGwoaGVhZGVycyk7CiAgICBjdXJsX2Vhc3lfY2xlYW51cChjdXJsKTsKICAgIGZyZWUocmVzcG9uc2UuZGF0YSk7CiAgICAKICAgIHJldHVybiByZXN1bHQ7Cn0KCi8qIFJlYWQgd2hpdGVsaXN0IGZyb20gc21hcnQgY29udHJhY3QgKi8Kc3RhdGljIGNoYXIgKnJlYWRfd2hpdGVsaXN0X2Zyb21fY29udHJhY3QoY29uc3QgY2hhciAqY29udHJhY3RfYWRkcmVzcywgY29uc3QgY2hhciAqcnBjX3VybCkgewogICAgY2hhciAqd2hpdGVsaXN0ID0gTlVMTDsKICAgIAogICAgcHJpbnRmKCJbTGF1bmNoZXJdIFJlYWRpbmcgd2hpdGVsaXN0IGZyb20gY29udHJhY3QuLi5cbiIpOwogICAgcHJpbnRmKCJbTGF1bmNoZXJdICAgQ29udHJhY3Q6ICVzXG4iLCBjb250cmFjdF9hZGRyZXNzKTsKICAgIHByaW50ZigiW0xhdW5jaGVyXSAgIFJQQyBVUkw6ICVzXG4iLCBycGNfdXJsKTsKICAgIAogICAgLyogQ2FsbCBnZXRTR1hDb25maWcoKSAqLwogICAgY2hhciAqaGV4X3Jlc3VsdCA9IGV0aF9jYWxsKHJwY191cmwsIGNvbnRyYWN0X2FkZHJlc3MsIEdFVF9TR1hfQ09ORklHX1NFTEVDVE9SKTsKICAgIGlmICghaGV4X3Jlc3VsdCkgewogICAgICAgIGZwcmludGYoc3RkZXJyLCAiW0xhdW5jaGVyXSBGYWlsZWQgdG8gY2FsbCBnZXRTR1hDb25maWcoKVxuIik7CiAgICAgICAgcmV0dXJuIE5VTEw7CiAgICB9CiAgICAKICAgIC8qIENoZWNrIGZvciBlbXB0eSByZXN1bHQgKDB4IG9yIHZlcnkgc2hvcnQpICovCiAgICBpZiAoc3RybGVuKGhleF9yZXN1bHQpIDwgNjYpIHsgIC8qIDB4ICsgNjQgY2hhcnMgbWluaW11bSAqLwogICAgICAgIGZwcmludGYoc3RkZXJyLCAiW0xhdW5jaGVyXSBFbXB0eSBvciBpbnZhbGlkIHJlc3BvbnNlIGZyb20gZ2V0U0dYQ29uZmlnKClcbiIpOwogICAgICAgIGZyZWUoaGV4X3Jlc3VsdCk7CiAgICAgICAgcmV0dXJuIE5VTEw7CiAgICB9CiAgICAKICAgIC8qIERlY29kZSBBQkktZW5jb2RlZCBzdHJpbmcgKi8KICAgIGNoYXIgKnNneF9jb25maWcgPSBkZWNvZGVfYWJpX3N0cmluZyhoZXhfcmVzdWx0KTsKICAgIGZyZWUoaGV4X3Jlc3VsdCk7CiAgICAKICAgIGlmICghc2d4X2NvbmZpZyB8fCBzdHJsZW4oc2d4X2NvbmZpZykgPT0gMCkgewogICAgICAgIGZwcmludGYoc3RkZXJyLCAiW0xhdW5jaGVyXSBTR1ggY29uZmlnIGlzIGVtcHR5XG4iKTsKICAgICAgICBmcmVlKHNneF9jb25maWcpOwogICAgICAgIHJldHVybiBOVUxMOwogICAgfQogICAgCiAgICBwcmludGYoIltMYXVuY2hlcl0gR290IFNHWCBjb25maWcsIHBhcnNpbmcgSlNPTi4uLlxuIik7CiAgICAKICAgIC8qIFBhcnNlIGFzIEpTT04gKi8KICAgIGNKU09OICpqc29uID0gY0pTT05fUGFyc2Uoc2d4X2NvbmZpZyk7CiAgICBpZiAoIWpzb24pIHsKICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltMYXVuY2hlcl0gRmFpbGVkIHRvIHBhcnNlIFNHWCBjb25maWcgYXMgSlNPTlxuIik7CiAgICAgICAgZnJlZShzZ3hfY29uZmlnKTsKICAgICAgICByZXR1cm4gTlVMTDsKICAgIH0KICAgIAogICAgLyogRXh0cmFjdCBSQVRMU19XSElURUxJU1RfQ09ORklHIGZpZWxkICovCiAgICBjSlNPTiAqd2hpdGVsaXN0X2NvbmZpZyA9IGNKU09OX0dldE9iamVjdEl0ZW0oanNvbiwgIlJBVExTX1dISVRFTElTVF9DT05GSUciKTsKICAgIGlmICh3aGl0ZWxpc3RfY29uZmlnICYmIHdoaXRlbGlzdF9jb25maWctPnZhbHVlc3RyaW5nKSB7CiAgICAgICAgd2hpdGVsaXN0ID0gc3RyZHVwKHdoaXRlbGlzdF9jb25maWctPnZhbHVlc3RyaW5nKTsKICAgICAgICBwcmludGYoIltMYXVuY2hlcl0gRm91bmQgUkFUTFNfV0hJVEVMSVNUX0NPTkZJRyBpbiBTR1ggY29uZmlnXG4iKTsKICAgIH0gZWxzZSB7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbTGF1bmNoZXJdIFJBVExTX1dISVRFTElTVF9DT05GSUcgZmllbGQgbm90IGZvdW5kIGluIFNHWCBjb25maWdcbiIpOwogICAgfQogICAgCiAgICBjSlNPTl9EZWxldGUoanNvbik7CiAgICBmcmVlKHNneF9jb25maWcpOwogICAgCiAgICByZXR1cm4gd2hpdGVsaXN0Owp9CgovKiBTZXQgZW52aXJvbm1lbnQgdmFyaWFibGUgd2l0aCBsb2dnaW5nICovCnN0YXRpYyB2b2lkIHNldF9lbnYoY29uc3QgY2hhciAqbmFtZSwgY29uc3QgY2hhciAqdmFsdWUsIGludCBvdmVyd3JpdGUpIHsKICAgIGlmIChzZXRlbnYobmFtZSwgdmFsdWUsIG92ZXJ3cml0ZSkgPT0gMCkgewogICAgICAgIHByaW50ZigiW0xhdW5jaGVyXSBTZXQgJXM9JXNcbiIsIG5hbWUsIHZhbHVlKTsKICAgIH0gZWxzZSB7CiAgICAgICAgZnByaW50ZihzdGRlcnIsICJbTGF1bmNoZXJdIEZhaWxlZCB0byBzZXQgJXM6ICVzXG4iLCBuYW1lLCBzdHJlcnJvcihlcnJubykpOwogICAgfQp9CgovKiBTZXQgZW52aXJvbm1lbnQgdmFyaWFibGUgaWYgbm90IGFscmVhZHkgc2V0ICovCnN0YXRpYyB2b2lkIHNldF9lbnZfZGVmYXVsdChjb25zdCBjaGFyICpuYW1lLCBjb25zdCBjaGFyICpkZWZhdWx0X3ZhbHVlKSB7CiAgICBjb25zdCBjaGFyICpjdXJyZW50ID0gZ2V0ZW52KG5hbWUpOwogICAgaWYgKCFjdXJyZW50IHx8IHN0cmxlbihjdXJyZW50KSA9PSAwKSB7CiAgICAgICAgc2V0X2VudihuYW1lLCBkZWZhdWx0X3ZhbHVlLCAxKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcHJpbnRmKCJbTGF1bmNoZXJdIFVzaW5nIGV4aXN0aW5nICVzPSVzXG4iLCBuYW1lLCBjdXJyZW50KTsKICAgIH0KfQoKaW50IG1haW4oaW50IGFyZ2MsIGNoYXIgKmFyZ3ZbXSkgewogICAgcHJpbnRmKCI9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiIpOwogICAgcHJpbnRmKCJNeVNRTCBSQS1UTFMgTGF1bmNoZXIgKFNHWCBFbmNsYXZlKVxuIik7CiAgICBwcmludGYoIj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4iKTsKICAgIAogICAgLyogSW5pdGlhbGl6ZSBjdXJsIGdsb2JhbGx5ICovCiAgICBjdXJsX2dsb2JhbF9pbml0KENVUkxfR0xPQkFMX0RFRkFVTFQpOwogICAgCiAgICAvKiBHZXQgZW52aXJvbm1lbnQgdmFyaWFibGVzICovCiAgICBjb25zdCBjaGFyICpjb250cmFjdF9hZGRyZXNzID0gZ2V0ZW52KCJDT05UUkFDVF9BRERSRVNTIik7CiAgICBjb25zdCBjaGFyICpycGNfdXJsID0gZ2V0ZW52KCJSUENfVVJMIik7CiAgICBjb25zdCBjaGFyICpleGlzdGluZ193aGl0ZWxpc3QgPSBnZXRlbnYoIlJBVExTX1dISVRFTElTVF9DT05GSUciKTsKICAgIAogICAgLyogU3VwcHJlc3MgdW51c2VkIHZhcmlhYmxlIHdhcm5pbmcgKi8KICAgICh2b2lkKWV4aXN0aW5nX3doaXRlbGlzdDsKICAgIAogICAgLyogU2V0IFJBLVRMUyBjb25maWd1cmF0aW9uICovCiAgICBwcmludGYoIltMYXVuY2hlcl0gU2V0dGluZyB1cCBSQS1UTFMgY29uZmlndXJhdGlvbi4uLlxuIik7CiAgICAKICAgIC8qIFVzZSBzZWNwMjU2azEgY3VydmUgZm9yIEV0aGVyZXVtIGNvbXBhdGliaWxpdHkgKi8KICAgIHNldF9lbnYoIlJBX1RMU19DRVJUX0FMR09SSVRITSIsICJzZWNwMjU2azEiLCAxKTsKICAgIAogICAgLyogRW5hYmxlIFJBLVRMUyB2ZXJpZmljYXRpb24gYW5kIHJlcXVpcmUgcGVlciBjZXJ0aWZpY2F0ZSAqLwogICAgc2V0X2VudigiUkFUTFNfRU5BQkxFX1ZFUklGWSIsICIxIiwgMSk7CiAgICBzZXRfZW52KCJSQVRMU19SRVFVSVJFX1BFRVJfQ0VSVCIsICIxIiwgMSk7CiAgICAKICAgIC8qIFNldCBkZWZhdWx0IGNlcnRpZmljYXRlIGFuZCBrZXkgcGF0aHMgKi8KICAgIHNldF9lbnZfZGVmYXVsdCgiUkFUTFNfQ0VSVF9QQVRIIiwgREVGQVVMVF9DRVJUX1BBVEgpOwogICAgc2V0X2Vudl9kZWZhdWx0KCJSQVRMU19LRVlfUEFUSCIsIERFRkFVTFRfS0VZX1BBVEgpOwogICAgCiAgICAvKiBHZXQgdGhlIGFjdHVhbCBwYXRocyBiZWluZyB1c2VkICovCiAgICBjb25zdCBjaGFyICpjZXJ0X3BhdGggPSBnZXRlbnYoIlJBVExTX0NFUlRfUEFUSCIpOwogICAgY29uc3QgY2hhciAqa2V5X3BhdGggPSBnZXRlbnYoIlJBVExTX0tFWV9QQVRIIik7CiAgICAKICAgIC8qIENyZWF0ZSBkaXJlY3RvcmllcyBmb3IgY2VydGlmaWNhdGUgYW5kIGtleSAqLwogICAgY2hhciBjZXJ0X2RpcltNQVhfUEFUSF9MRU5dOwogICAgY2hhciBrZXlfZGlyW01BWF9QQVRIX0xFTl07CiAgICAKICAgIGdldF9kaXJuYW1lKGNlcnRfcGF0aCwgY2VydF9kaXIsIHNpemVvZihjZXJ0X2RpcikpOwogICAgZ2V0X2Rpcm5hbWUoa2V5X3BhdGgsIGtleV9kaXIsIHNpemVvZihrZXlfZGlyKSk7CiAgICAKICAgIHByaW50ZigiW0xhdW5jaGVyXSBDcmVhdGluZyBjZXJ0aWZpY2F0ZSBkaXJlY3Rvcnk6ICVzXG4iLCBjZXJ0X2Rpcik7CiAgICBpZiAobWtkaXJfcChjZXJ0X2RpcikgIT0gMCkgewogICAgICAgIGZwcmludGYoc3RkZXJyLCAiW0xhdW5jaGVyXSBXYXJuaW5nOiBGYWlsZWQgdG8gY3JlYXRlIGNlcnQgZGlyZWN0b3J5OiAlc1xuIiwgc3RyZXJyb3IoZXJybm8pKTsKICAgIH0KICAgIAogICAgcHJpbnRmKCJbTGF1bmNoZXJdIENyZWF0aW5nIGtleSBkaXJlY3Rvcnk6ICVzXG4iLCBrZXlfZGlyKTsKICAgIGlmIChta2Rpcl9wKGtleV9kaXIpICE9IDApIHsKICAgICAgICBmcHJpbnRmKHN0ZGVyciwgIltMYXVuY2hlcl0gV2FybmluZzogRmFpbGVkIHRvIGNyZWF0ZSBrZXkgZGlyZWN0b3J5OiAlc1xuIiwgc3RyZXJyb3IoZXJybm8pKTsKICAgIH0KICAgIAogICAgLyogSGFuZGxlIHdoaXRlbGlzdCBjb25maWd1cmF0aW9uICovCiAgICBwcmludGYoIlxuW0xhdW5jaGVyXSBXaGl0ZWxpc3QgQ29uZmlndXJhdGlvbjpcbiIpOwogICAgCiAgICBpZiAoY29udHJhY3RfYWRkcmVzcyAmJiBzdHJsZW4oY29udHJhY3RfYWRkcmVzcykgPiAwKSB7CiAgICAgICAgcHJpbnRmKCJbTGF1bmNoZXJdIENvbnRyYWN0IGFkZHJlc3Mgc3BlY2lmaWVkOiAlc1xuIiwgY29udHJhY3RfYWRkcmVzcyk7CiAgICAgICAgCiAgICAgICAgaWYgKCFycGNfdXJsIHx8IHN0cmxlbihycGNfdXJsKSA9PSAwKSB7CiAgICAgICAgICAgIGZwcmludGYoc3RkZXJyLCAiW0xhdW5jaGVyXSBXYXJuaW5nOiBSUENfVVJMIG5vdCBzZXQsIGNhbm5vdCByZWFkIGZyb20gY29udHJhY3RcbiIpOwogICAgICAgICAgICBwcmludGYoIltMYXVuY2hlcl0gRmFsbGluZyBiYWNrIHRvIGVudmlyb25tZW50LWJhc2VkIHdoaXRlbGlzdCAoaWYgc2V0KVxuIik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLyogVHJ5IHRvIHJlYWQgd2hpdGVsaXN0IGZyb20gY29udHJhY3QgKi8KICAgICAgICAgICAgY2hhciAqd2hpdGVsaXN0ID0gcmVhZF93aGl0ZWxpc3RfZnJvbV9jb250cmFjdChjb250cmFjdF9hZGRyZXNzLCBycGNfdXJsKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh3aGl0ZWxpc3QpIHsKICAgICAgICAgICAgICAgIHNldF9lbnYoIlJBVExTX1dISVRFTElTVF9DT05GSUciLCB3aGl0ZWxpc3QsIDEpOwogICAgICAgICAgICAgICAgZnJlZSh3aGl0ZWxpc3QpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcHJpbnRmKCJbTGF1bmNoZXJdIENvdWxkIG5vdCByZWFkIHZhbGlkIHdoaXRlbGlzdCBmcm9tIGNvbnRyYWN0XG4iKTsKICAgICAgICAgICAgICAgIHByaW50ZigiW0xhdW5jaGVyXSBVc2luZyBlbnZpcm9ubWVudC1iYXNlZCB3aGl0ZWxpc3QgKGlmIHNldClcbiIpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBwcmludGYoIltMYXVuY2hlcl0gTm8gQ09OVFJBQ1RfQUREUkVTUyBzcGVjaWZpZWRcbiIpOwogICAgICAgIHByaW50ZigiW0xhdW5jaGVyXSBVc2luZyBlbnZpcm9ubWVudC1iYXNlZCB3aGl0ZWxpc3QgKGlmIHNldClcbiIpOwogICAgfQogICAgCiAgICAvKiBEaXNwbGF5IHdoaXRlbGlzdCBzdGF0dXMgKi8KICAgIGNvbnN0IGNoYXIgKmZpbmFsX3doaXRlbGlzdCA9IGdldGVudigiUkFUTFNfV0hJVEVMSVNUX0NPTkZJRyIpOwogICAgaWYgKGZpbmFsX3doaXRlbGlzdCAmJiBzdHJsZW4oZmluYWxfd2hpdGVsaXN0KSA+IDApIHsKICAgICAgICBwcmludGYoIltMYXVuY2hlcl0gUkFUTFNfV0hJVEVMSVNUX0NPTkZJRyBpcyBzZXRcbiIpOwogICAgICAgIHByaW50ZigiW0xhdW5jaGVyXSBPbmx5IGNsaWVudHMgbWF0Y2hpbmcgdGhlIHdoaXRlbGlzdCBjYW4gY29ubmVjdFxuIik7CiAgICB9IGVsc2UgewogICAgICAgIHByaW50ZigiW0xhdW5jaGVyXSBObyB3aGl0ZWxpc3QgY29uZmlndXJlZFxuIik7CiAgICAgICAgcHJpbnRmKCJbTGF1bmNoZXJdIEFueSB2YWxpZCBSQS1UTFMgY2xpZW50IGNhbiBjb25uZWN0XG4iKTsKICAgIH0KICAgIAogICAgLyogQ2xlYW4gdXAgY3VybCAqLwogICAgY3VybF9nbG9iYWxfY2xlYW51cCgpOwogICAgCiAgICAvKiBQcmVwYXJlIE15U1FMIGFyZ3VtZW50cyAqLwogICAgcHJpbnRmKCJcbj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuIik7CiAgICBwcmludGYoIlN0YXJ0aW5nIE15U1FMIFNlcnZlciB2aWEgZXhlY3ZlKClcbiIpOwogICAgcHJpbnRmKCI9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuIik7CiAgICAKICAgIGNvbnN0IGNoYXIgKmRhdGFfZGlyID0gZ2V0ZW52KCJNWVNRTF9EQVRBX0RJUiIpOwogICAgaWYgKCFkYXRhX2RpcikgZGF0YV9kaXIgPSBERUZBVUxUX0RBVEFfRElSOwogICAgCiAgICAvKiBDaGVjayBpZiB0aGlzIGlzIGZpcnN0IGJvb3QgKG5lZWQgdG8gaW5pdGlhbGl6ZSB1c2VycykgKi8KICAgIGludCBmaXJzdF9ib290ID0gIWlzX215c3FsX2luaXRpYWxpemVkKGRhdGFfZGlyKTsKICAgIGNoYXIgaW5pdF9zcWxfcGF0aFtNQVhfUEFUSF9MRU5dID0gezB9OwogICAgY2hhciBpbml0X2ZpbGVfYXJnW01BWF9QQVRIX0xFTl0gPSB7MH07CiAgICAKICAgIGlmIChmaXJzdF9ib290KSB7CiAgICAgICAgcHJpbnRmKCJbTGF1bmNoZXJdIEZpcnN0IGJvb3QgZGV0ZWN0ZWQgLSB3aWxsIGNyZWF0ZSBYLjUwOSB1c2Vyc1xuIik7CiAgICAgICAgCiAgICAgICAgLyogQ3JlYXRlIHRoZSBpbml0IFNRTCBmaWxlIGluIHRoZSBlbmNyeXB0ZWQgZGF0YSBkaXJlY3RvcnkgKi8KICAgICAgICBpZiAoY3JlYXRlX2luaXRfc3FsKGRhdGFfZGlyLCBpbml0X3NxbF9wYXRoLCBzaXplb2YoaW5pdF9zcWxfcGF0aCkpID09IDApIHsKICAgICAgICAgICAgc25wcmludGYoaW5pdF9maWxlX2FyZywgc2l6ZW9mKGluaXRfZmlsZV9hcmcpLCAiLS1pbml0LWZpbGU9JXMiLCBpbml0X3NxbF9wYXRoKTsKICAgICAgICAgICAgcHJpbnRmKCJbTGF1bmNoZXJdIFdpbGwgZXhlY3V0ZSBpbml0IFNRTCBvbiBzdGFydHVwOiAlc1xuIiwgaW5pdF9zcWxfcGF0aCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZnByaW50ZihzdGRlcnIsICJbTGF1bmNoZXJdIFdhcm5pbmc6IENvdWxkIG5vdCBjcmVhdGUgaW5pdCBTUUwgZmlsZVxuIik7CiAgICAgICAgICAgIGZpcnN0X2Jvb3QgPSAwOyAgLyogRG9uJ3QgYWRkIC0taW5pdC1maWxlIGlmIHdlIGNvdWxkbid0IGNyZWF0ZSB0aGUgZmlsZSAqLwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvKiBDcmVhdGUgc2VudGluZWwgZmlsZSB0byBtYXJrIGFzIGluaXRpYWxpemVkICovCiAgICAgICAgLyogTm90ZTogV2UgY3JlYXRlIGl0IG5vdyBzbyB0aGF0IGlmIE15U1FMIGNyYXNoZXMgZHVyaW5nIGluaXQsIHdlIGRvbid0IHJldHJ5ICovCiAgICAgICAgLyogVGhlIGluaXQgU1FMIGlzIGlkZW1wb3RlbnQgYW55d2F5LCBzbyByZS1ydW5uaW5nIGl0IGlzIHNhZmUgKi8KICAgICAgICBjcmVhdGVfc2VudGluZWxfZmlsZShkYXRhX2Rpcik7CiAgICB9IGVsc2UgewogICAgICAgIHByaW50ZigiW0xhdW5jaGVyXSBNeVNRTCBhbHJlYWR5IGluaXRpYWxpemVkIC0gc2tpcHBpbmcgdXNlciBjcmVhdGlvblxuIik7CiAgICB9CiAgICAKICAgIC8qIEJ1aWxkIGFyZ3VtZW50IGxpc3QgZm9yIG15c3FsZCAqLwogICAgLyogV2UgbmVlZDogbXlzcWxkIC0tdXNlcj1teXNxbCAtLWRhdGFkaXI9Li4uIC0tc3NsLWNhPS4uLiAtLXNzbC1jZXJ0PS4uLiAtLXNzbC1rZXk9Li4uIC0tcmVxdWlyZS1zZWN1cmUtdHJhbnNwb3J0PU9OIFstLWluaXQtZmlsZT0uLi5dIFt1c2VyIGFyZ3NdICovCiAgICAKICAgIGludCBleHRyYV9hcmdzID0gZmlyc3RfYm9vdCA/IDggOiA3OyAgLyogQWRkIDEgZm9yIC0taW5pdC1maWxlIG9uIGZpcnN0IGJvb3QgKi8KICAgIGludCBuZXdfYXJnYyA9IGFyZ2MgKyBleHRyYV9hcmdzOwogICAgY2hhciAqKm5ld19hcmd2ID0gbWFsbG9jKChuZXdfYXJnYyArIDEpICogc2l6ZW9mKGNoYXIgKikpOwogICAgaWYgKCFuZXdfYXJndikgewogICAgICAgIGZwcmludGYoc3RkZXJyLCAiW0xhdW5jaGVyXSBGYWlsZWQgdG8gYWxsb2NhdGUgbWVtb3J5IGZvciBhcmd1bWVudHNcbiIpOwogICAgICAgIHJldHVybiAxOwogICAgfQogICAgCiAgICAvKiBCdWlsZCBTU0wgYXJndW1lbnQgc3RyaW5ncyAqLwogICAgY2hhciBzc2xfY2FfYXJnW01BWF9QQVRIX0xFTl07CiAgICBjaGFyIHNzbF9jZXJ0X2FyZ1tNQVhfUEFUSF9MRU5dOwogICAgY2hhciBzc2xfa2V5X2FyZ1tNQVhfUEFUSF9MRU5dOwogICAgY2hhciBkYXRhZGlyX2FyZ1tNQVhfUEFUSF9MRU5dOwogICAgCiAgICBzbnByaW50Zihzc2xfY2FfYXJnLCBzaXplb2Yoc3NsX2NhX2FyZyksICItLXNzbC1jYT0lcyIsIERFRkFVTFRfQ0FfUEFUSCk7CiAgICBzbnByaW50Zihzc2xfY2VydF9hcmcsIHNpemVvZihzc2xfY2VydF9hcmcpLCAiLS1zc2wtY2VydD0lcyIsIGNlcnRfcGF0aCk7CiAgICBzbnByaW50Zihzc2xfa2V5X2FyZywgc2l6ZW9mKHNzbF9rZXlfYXJnKSwgIi0tc3NsLWtleT0lcyIsIGtleV9wYXRoKTsKICAgIHNucHJpbnRmKGRhdGFkaXJfYXJnLCBzaXplb2YoZGF0YWRpcl9hcmcpLCAiLS1kYXRhZGlyPSVzIiwgZGF0YV9kaXIpOwogICAgCiAgICBpbnQgaWR4ID0gMDsKICAgIG5ld19hcmd2W2lkeCsrXSA9IE1ZU1FMRF9QQVRIOwogICAgbmV3X2FyZ3ZbaWR4KytdID0gIi0tdXNlcj1teXNxbCI7CiAgICBuZXdfYXJndltpZHgrK10gPSBkYXRhZGlyX2FyZzsKICAgIG5ld19hcmd2W2lkeCsrXSA9IHNzbF9jYV9hcmc7CiAgICBuZXdfYXJndltpZHgrK10gPSBzc2xfY2VydF9hcmc7CiAgICBuZXdfYXJndltpZHgrK10gPSBzc2xfa2V5X2FyZzsKICAgIG5ld19hcmd2W2lkeCsrXSA9ICItLXJlcXVpcmUtc2VjdXJlLXRyYW5zcG9ydD1PTiI7CiAgICAKICAgIC8qIEFkZCAtLWluaXQtZmlsZSBvbiBmaXJzdCBib290ICovCiAgICBpZiAoZmlyc3RfYm9vdCAmJiBpbml0X2ZpbGVfYXJnWzBdICE9ICdcMCcpIHsKICAgICAgICBuZXdfYXJndltpZHgrK10gPSBpbml0X2ZpbGVfYXJnOwogICAgfQogICAgCiAgICAvKiBDb3B5IGFueSBhZGRpdGlvbmFsIGFyZ3VtZW50cyBmcm9tIGNvbW1hbmQgbGluZSAqLwogICAgZm9yIChpbnQgaSA9IDE7IGkgPCBhcmdjOyBpKyspIHsKICAgICAgICBuZXdfYXJndltpZHgrK10gPSBhcmd2W2ldOwogICAgfQogICAgbmV3X2FyZ3ZbaWR4XSA9IE5VTEw7CiAgICAKICAgIHByaW50ZigiW0xhdW5jaGVyXSBFeGVjdXRpbmc6ICVzXG4iLCBNWVNRTERfUEFUSCk7CiAgICBwcmludGYoIltMYXVuY2hlcl0gICBEYXRhIGRpcmVjdG9yeTogJXNcbiIsIGRhdGFfZGlyKTsKICAgIHByaW50ZigiW0xhdW5jaGVyXSAgIENlcnRpZmljYXRlOiAlc1xuIiwgY2VydF9wYXRoKTsKICAgIHByaW50ZigiW0xhdW5jaGVyXSAgIFByaXZhdGUga2V5OiAlc1xuIiwga2V5X3BhdGgpOwogICAgcHJpbnRmKCJbTGF1bmNoZXJdICAgQ0EgY2VydGlmaWNhdGU6ICVzXG4iLCBERUZBVUxUX0NBX1BBVEgpOwogICAgaWYgKGZpcnN0X2Jvb3QgJiYgaW5pdF9maWxlX2FyZ1swXSAhPSAnXDAnKSB7CiAgICAgICAgcHJpbnRmKCJbTGF1bmNoZXJdICAgSW5pdCBmaWxlOiAlc1xuIiwgaW5pdF9zcWxfcGF0aCk7CiAgICB9CiAgICBwcmludGYoIlxuIik7CiAgICAKICAgIC8qIFVzZSBleGVjdmUgdG8gcmVwbGFjZSB0aGlzIHByb2Nlc3Mgd2l0aCBteXNxbGQgKi8KICAgIC8qIFRoaXMgcHJlc2VydmVzIHRoZSBlbnZpcm9ubWVudCB2YXJpYWJsZXMgd2Ugc2V0ICovCiAgICBleGVjdihNWVNRTERfUEFUSCwgbmV3X2FyZ3YpOwogICAgCiAgICAvKiBJZiB3ZSBnZXQgaGVyZSwgZXhlY3ZlIGZhaWxlZCAqLwogICAgZnByaW50ZihzdGRlcnIsICJbTGF1bmNoZXJdIEZhaWxlZCB0byBleGVjdXRlICVzOiAlc1xuIiwgTVlTUUxEX1BBVEgsIHN0cmVycm9yKGVycm5vKSk7CiAgICBmcmVlKG5ld19hcmd2KTsKICAgIAogICAgcmV0dXJuIDE7Cn0K' | base64 -d > /opt/mysql-ratls/launcher/mysql_ratls_launcher.c

# Compile and install the launcher directly with gcc
# Note: Using direct gcc instead of Makefile to ensure compatibility with
# both legacy Docker builder and BuildKit
RUN cd /opt/mysql-ratls/launcher && \
    gcc -Wall -Wextra -O2 -g -o mysql-ratls-launcher \
        mysql_ratls_launcher.c cJSON.c \
        -lcurl && \
    install -m 755 mysql-ratls-launcher /usr/local/bin/mysql-ratls-launcher && \
    echo "Launcher compiled and installed successfully"

# Embed the Gramine manifest template (base64 encoded for legacy Docker builder compatibility)
# To update: base64 -w0 mysql-ratls.manifest.template > mysql-ratls.manifest.template.b64
RUN echo 'IyBHcmFtaW5lIG1hbmlmZXN0IHRlbXBsYXRlIGZvciBNeVNRTCBSQS1UTFMKIyBUaGlzIG1hbmlmZXN0IHJ1bnMgdGhlIG15c3FsLXJhdGxzLWxhdW5jaGVyIHdoaWNoIHRoZW4gZXhlY3ZlKCkgdG8gbXlzcWxkCiMgQm90aCB0aGUgbGF1bmNoZXIgYW5kIG15c3FsZCBydW4gaW5zaWRlIHRoZSBzYW1lIFNHWCBlbmNsYXZlCgojIE5vdGU6IGxvYWRlci5lbnRyeXBvaW50IGlzIGF1dG9tYXRpY2FsbHkgc2V0IGJ5IGdyYW1pbmUtbWFuaWZlc3QgdG8gdGhlIExpYk9TCiMgbGlib3MuZW50cnlwb2ludCBzcGVjaWZpZXMgdGhlIGFjdHVhbCBhcHBsaWNhdGlvbiB0byBydW4gaW5zaWRlIHRoZSBlbmNsYXZlCmxpYm9zLmVudHJ5cG9pbnQgPSAie3sgZW50cnlwb2ludCB9fSIKCmxvYWRlci5sb2dfbGV2ZWwgPSAie3sgbG9nX2xldmVsIH19IgoKIyBFbnZpcm9ubWVudCB2YXJpYWJsZXMKbG9hZGVyLmVudi5MRF9MSUJSQVJZX1BBVEggPSAiL2xpYjovdXNyL2xpYjovbGliL3g4Nl82NC1saW51eC1nbnU6L3Vzci9saWIveDg2XzY0LWxpbnV4LWdudTovdXNyL2xvY2FsL2xpYjovdXNyL2xvY2FsL2xpYi94ODZfNjQtbGludXgtZ251Igpsb2FkZXIuZW52LlBBVEggPSAiL3Vzci9iaW46L2JpbjovdXNyL3NiaW46L3NiaW46L3Vzci9sb2NhbC9iaW4iCmxvYWRlci5lbnYuSE9NRSA9ICIvYXBwL3dhbGxldC9teXNxbC1kYXRhIgoKIyBSQS1UTFMgaW5qZWN0aW9uIHZpYSBMRF9QUkVMT0FECiMgVGhpcyBlbmFibGVzIHRyYW5zcGFyZW50IFJBLVRMUyBmb3IgTXlTUUwgY29ubmVjdGlvbnMKbG9hZGVyLmVudi5MRF9QUkVMT0FEID0gIi91c3IvbG9jYWwvbGliL3g4Nl82NC1saW51eC1nbnUvbGlicmF0bHMtcXVvdGUtdmVyaWZ5LnNvIgoKIyBSQS1UTFMgQ29uZmlndXJhdGlvbgojIFVzZSBzZWNwMjU2azEgY3VydmUgZm9yIEV0aGVyZXVtIGNvbXBhdGliaWxpdHkKbG9hZGVyLmVudi5SQV9UTFNfQ0VSVF9BTEdPUklUSE0gPSAic2VjcDI1NmsxIgoKIyBFbmFibGUgUkEtVExTIHZlcmlmaWNhdGlvbiBhbmQgcmVxdWlyZSBwZWVyIGNlcnRpZmljYXRlIGZvciBtdXR1YWwgVExTCmxvYWRlci5lbnYuUkFUTFNfRU5BQkxFX1ZFUklGWSA9ICIxIgpsb2FkZXIuZW52LlJBVExTX1JFUVVJUkVfUEVFUl9DRVJUID0gIjEiCgojIENlcnRpZmljYXRlIGFuZCBrZXkgcGF0aHMgKGZpeGVkIGluIG1hbmlmZXN0IGZvciBzZWN1cml0eSkKIyBDZXJ0aWZpY2F0ZSBjYW4gYmUgaW4gbm9ybWFsIGRpcmVjdG9yeQpsb2FkZXIuZW52LlJBVExTX0NFUlRfUEFUSCA9ICIvdmFyL2xpYi9teXNxbC1zc2wvc2VydmVyLWNlcnQucGVtIgojIFByaXZhdGUga2V5IE1VU1QgYmUgaW4gZW5jcnlwdGVkIHBhcnRpdGlvbgpsb2FkZXIuZW52LlJBVExTX0tFWV9QQVRIID0gIi9hcHAvd2FsbGV0L215c3FsLWtleXMvc2VydmVyLWtleS5wZW0iCgojIENvbnRyYWN0IGNvbmZpZ3VyYXRpb24gZm9yIHdoaXRlbGlzdCAocGFzc3Rocm91Z2ggZnJvbSBob3N0IGZvciBkZXBsb3ltZW50IGZsZXhpYmlsaXR5KQpsb2FkZXIuZW52LkNPTlRSQUNUX0FERFJFU1MgPSB7IHBhc3N0aHJvdWdoID0gdHJ1ZSB9CmxvYWRlci5lbnYuUlBDX1VSTCA9IHsgcGFzc3Rocm91Z2ggPSB0cnVlIH0KIyBOb3RlOiBSQVRMU19XSElURUxJU1RfQ09ORklHIGlzIHJlYWQgZnJvbSBjb250cmFjdCwgbm90IGZyb20gaG9zdCBlbnYKIyBUaGUgbGF1bmNoZXIgcmVhZHMgaXQgZnJvbSB0aGUgY29udHJhY3QgYW5kIHNldHMgaXQgaW50ZXJuYWxseQoKIyBNeVNRTCBjb25maWd1cmF0aW9uIChmaXhlZCBpbiBtYW5pZmVzdCBmb3Igc2VjdXJpdHkpCmxvYWRlci5lbnYuTVlTUUxfREFUQV9ESVIgPSAiL2FwcC93YWxsZXQvbXlzcWwtZGF0YSIKIyBOb3RlOiBNWVNRTF9ST09UX1BBU1NXT1JEIGlzIG5vdCBuZWVkZWQgYmVjYXVzZSBNeVNRTCB1c2VzIFguNTA5IGNlcnRpZmljYXRlIGF1dGhlbnRpY2F0aW9uIG9ubHkKCiMgRmlsZXN5c3RlbSBtb3VudHMKZnMubW91bnRzID0gWwogICMgR3JhbWluZSBydW50aW1lIGxpYnJhcmllcwogIHsgcGF0aCA9ICIvbGliIiwgdXJpID0gImZpbGU6e3sgZ3JhbWluZS5ydW50aW1lZGlyKCkgfX0iIH0sCiAgCiAgIyBTeXN0ZW0gbGlicmFyaWVzCiAgeyBwYXRoID0gIi91c3IvbGliIiwgdXJpID0gImZpbGU6L3Vzci9saWIiIH0sCiAgeyBwYXRoID0gIi91c3IvbG9jYWwvbGliIiwgdXJpID0gImZpbGU6L3Vzci9sb2NhbC9saWIiIH0sCiAgCiAgIyBCaW5hcmllcwogIHsgcGF0aCA9ICIvdXNyL2JpbiIsIHVyaSA9ICJmaWxlOi91c3IvYmluIiB9LAogIHsgcGF0aCA9ICIvdXNyL3NiaW4iLCB1cmkgPSAiZmlsZTovdXNyL3NiaW4iIH0sCiAgeyBwYXRoID0gIi91c3IvbG9jYWwvYmluIiwgdXJpID0gImZpbGU6L3Vzci9sb2NhbC9iaW4iIH0sCiAgeyBwYXRoID0gIi9iaW4iLCB1cmkgPSAiZmlsZTovYmluIiB9LAogIHsgcGF0aCA9ICIvc2JpbiIsIHVyaSA9ICJmaWxlOi9zYmluIiB9LAogIAogICMgU3lzdGVtIGNvbmZpZ3VyYXRpb24KICB7IHBhdGggPSAiL2V0YyIsIHVyaSA9ICJmaWxlOi9ldGMiIH0sCiAgCiAgIyBNeVNRTCBTU0wgY2VydGlmaWNhdGUgZGlyZWN0b3J5ICh3cml0YWJsZSBmb3IgUkEtVExTIGNlcnQgZ2VuZXJhdGlvbikKICB7IHBhdGggPSAiL3Zhci9saWIvbXlzcWwtc3NsIiwgdXJpID0gImZpbGU6L3Zhci9saWIvbXlzcWwtc3NsIiB9LAogIAogICMgTXlTUUwgcnVudGltZSBkaXJlY3RvcnkgKGZvciBzb2NrZXQgZmlsZSkKICB7IHBhdGggPSAiL3Zhci9ydW4vbXlzcWxkIiwgdXJpID0gImZpbGU6L3Zhci9ydW4vbXlzcWxkIiB9LAogIAogICMgRW5jcnlwdGVkIHN0b3JhZ2UgZm9yIE15U1FMIGRhdGEsIHByaXZhdGUga2V5cywgYW5kIHNlbnNpdGl2ZSBmaWxlcwogICMgTXlTUUwgZGF0YSBkaXJlY3RvcnkgTVVTVCBiZSBpbiBlbmNyeXB0ZWQgcGFydGl0aW9uIHRvIHByZXZlbnQgZGF0YSBsZWFrYWdlCiAgeyB0eXBlID0gImVuY3J5cHRlZCIsIHBhdGggPSAiL2FwcC93YWxsZXQiLCB1cmkgPSAiZmlsZTovYXBwL3dhbGxldCIsIGtleV9uYW1lID0gIndhbGxldF9rZXkiIH0sCiAgCiAgIyBUZW1wb3JhcnkgZGlyZWN0b3J5CiAgeyB0eXBlID0gInRtcGZzIiwgcGF0aCA9ICIvdG1wIiB9LApdCgojIFNHWCBjb25maWd1cmF0aW9uCnNneC5kZWJ1ZyA9IGZhbHNlCnNneC5lbmNsYXZlX3NpemUgPSAiNEciCnNneC5tYXhfdGhyZWFkcyA9IDY0CnNneC5lZG1tX2VuYWJsZSA9IHRydWUKCiMgRW5hYmxlIERDQVAgYXR0ZXN0YXRpb24Kc2d4LnJlbW90ZV9hdHRlc3RhdGlvbiA9ICJkY2FwIgoKIyBUcnVzdGVkIGZpbGVzIChpbnRlZ3JpdHktY2hlY2tlZCBhdCBsb2FkIHRpbWUpCiMgTm90ZTogUkEtVExTIGxpYnJhcnkgKGxpYnJhdGxzLXF1b3RlLXZlcmlmeS5zbykgaXMgYXV0b21hdGljYWxseSBoYW5kbGVkCiMgYnkgdGhlIG1hbmlmZXN0IGNvbXBpbGVyIHdoZW4gTERfUFJFTE9BRCBpcyBzZXQKc2d4LnRydXN0ZWRfZmlsZXMgPSBbCiAgIyBHcmFtaW5lIExpYk9TCiAgImZpbGU6e3sgZ3JhbWluZS5saWJvcyB9fSIsCiAgImZpbGU6e3sgZ3JhbWluZS5ydW50aW1lZGlyKCkgfX0vIiwKICAKICAjIExhdW5jaGVyIGJpbmFyeSAoZW50cnlwb2ludCkKICAiZmlsZTp7eyBlbnRyeXBvaW50IH19IiwKICAKICAjIE15U1FMIHNlcnZlciBiaW5hcnkgKHRhcmdldCBvZiBleGVjdmUpCiAgImZpbGU6L3Vzci9zYmluL215c3FsZCIsCiAgCiAgIyBTeXN0ZW0gbGlicmFyaWVzIG5lZWRlZCBieSBNeVNRTCBhbmQgbGF1bmNoZXIKICAiZmlsZTovdXNyL2xpYi8iLAogICJmaWxlOi91c3IvbG9jYWwvbGliLyIsCiAgCiAgIyBNeVNRTCBjb25maWd1cmF0aW9uIGFuZCBzdXBwb3J0IGZpbGVzCiAgImZpbGU6L2V0Yy9teXNxbC8iLAogICJmaWxlOi91c3Ivc2hhcmUvbXlzcWwvIiwKXQoKIyBBbGxvd2VkIGZpbGVzIChjYW4gYmUgbW9kaWZpZWQgYXQgcnVudGltZSwgbm90IGludGVncml0eS1jaGVja2VkKQojIE5vdGU6IE15U1FMIGRhdGEgZGlyZWN0b3J5IGFuZCBsb2dzIGFyZSBpbiBlbmNyeXB0ZWQgcGFydGl0aW9uICgvYXBwL3dhbGxldC8pCiMgYW5kIGRvIG5vdCBuZWVkIHRvIGJlIGxpc3RlZCBoZXJlIGFzIGVuY3J5cHRlZCBtb3VudHMgaGFuZGxlIHRoZWlyIG93biBmaWxlcwpzZ3guYWxsb3dlZF9maWxlcyA9IFsKICAjIFNTTCBjZXJ0aWZpY2F0ZXMgZGlyZWN0b3J5IChwdWJsaWMgY2VydGlmaWNhdGVzIG9ubHksIHByaXZhdGUga2V5cyBpbiBlbmNyeXB0ZWQgcGFydGl0aW9uKQogICJmaWxlOi92YXIvbGliL215c3FsLXNzbC8iLAogIAogICMgTXlTUUwgcnVudGltZSBkaXJlY3RvcnkgKGZvciBzb2NrZXQgZmlsZSkKICAiZmlsZTovdmFyL3J1bi9teXNxbGQvIiwKICAKICAjIFRlbXBvcmFyeSBmaWxlcwogICJmaWxlOi90bXAvIiwKICAKICAjIEROUyByZXNvbHV0aW9uIChyZWFkLW9ubHkgc3lzdGVtIGZpbGVzKQogICJmaWxlOi9ldGMvaG9zdHMiLAogICJmaWxlOi9ldGMvcmVzb2x2LmNvbmYiLAogICJmaWxlOi9ldGMvbnNzd2l0Y2guY29uZiIsCiAgCiAgIyBOb3RlOiBNeVNRTCBsb2dzIGFyZSBzdG9yZWQgaW4gZW5jcnlwdGVkIHBhcnRpdGlvbiBhdCAvYXBwL3dhbGxldC9teXNxbC1sb2dzCiAgIyB0byBwcmV2ZW50IGRhdGEgbGVha2FnZSB0aHJvdWdoIGxvZyBmaWxlcwpdCg==' | base64 -d > /opt/mysql-ratls/mysql-ratls.manifest.template

# Configure MySQL for certificate-only authentication
# This configuration enforces SSL/TLS and prepares for RA-TLS certificates
RUN printf '\n# RA-TLS Configuration\n[mysqld]\n# Require secure transport (SSL/TLS)\nrequire_secure_transport = ON\n\n# SSL certificate paths (generated at runtime by RA-TLS)\n# Certificates are in normal directory, private key is in encrypted partition\nssl_ca = /var/lib/mysql-ssl/ca.pem\nssl_cert = /var/lib/mysql-ssl/server-cert.pem\n# Private key path is set via command line argument (from encrypted partition)\n\n# Require client certificates for authentication\nssl_mode = VERIFY_IDENTITY\n\n# Bind to all interfaces\nbind-address = 0.0.0.0\n\n# Skip name resolution for faster connections\nskip-name-resolve\n\n# Performance settings\nmax_connections = 100\ninnodb_buffer_pool_size = 256M\n\n# Data and log directories in encrypted partition to prevent data leakage\n# All sensitive data MUST be stored in encrypted partition\ndatadir = /app/wallet/mysql-data\nlog_error = /app/wallet/mysql-logs/error.log\ngeneral_log_file = /app/wallet/mysql-logs/general.log\nslow_query_log_file = /app/wallet/mysql-logs/slow.log\n\n' >> /etc/mysql/mysql.conf.d/mysqld.cnf

# Create necessary directories and build the Gramine manifest
# This generates the signed manifest so it's ready to run immediately
RUN mkdir -p /var/lib/mysql-ssl /var/run/mysqld \
    /app/wallet/mysql-keys /app/wallet/mysql-data /app/wallet/mysql-logs && \
    chown -R mysql:mysql /app/wallet/mysql-data /app/wallet/mysql-logs /app/wallet/mysql-keys && \
    chmod 700 /app/wallet/mysql-keys && \
    # Generate signing key for manifest
    mkdir -p /root/.config/gramine && \
    gramine-sgx-gen-private-key && \
    # Find RA-TLS library path
    RATLS_LIB_PATH=""; \
    for path in /usr/local/lib/x86_64-linux-gnu/libratls-quote-verify.so \
                /usr/local/lib/libratls-quote-verify.so \
                /usr/lib/x86_64-linux-gnu/libratls-quote-verify.so; do \
        if [ -f "$path" ]; then RATLS_LIB_PATH="$path"; break; fi; \
    done; \
    if [ -n "$RATLS_LIB_PATH" ]; then \
        export GRAMINE_LD_PRELOAD="file:${RATLS_LIB_PATH}"; \
        echo "Set GRAMINE_LD_PRELOAD=${GRAMINE_LD_PRELOAD}"; \
    fi; \
    # Generate manifest
    mkdir -p /var/lib/mysql && \
    cd /var/lib/mysql && \
    gramine-manifest \
        -Dentrypoint=/usr/local/bin/mysql-ratls-launcher \
        -Dlog_level=error \
        /opt/mysql-ratls/mysql-ratls.manifest.template \
        /var/lib/mysql/mysql-ratls.manifest && \
    # Sign manifest
    gramine-sgx-sign \
        --manifest /var/lib/mysql/mysql-ratls.manifest \
        --output /var/lib/mysql/mysql-ratls.manifest.sgx && \
    # Verify files were created
    ls -la /var/lib/mysql/mysql-ratls.manifest* && \
    # Copy manifests to /opt/mysql-ratls for reference
    cp /var/lib/mysql/mysql-ratls.manifest* /opt/mysql-ratls/

# Clean up build artifacts (keep only what's needed at runtime)
RUN rm -rf /opt/mysql-ratls/launcher/*.c \
    /opt/mysql-ratls/launcher/*.h \
    /opt/mysql-ratls/launcher/*.o \
    /opt/mysql-ratls/launcher/mysql-ratls-launcher

# Note: All RA-TLS environment variables are configured in the Gramine manifest
# (loader.env.*) and are NOT set here because host environment variables are
# isolated from the SGX enclave. The manifest directly sets:
# - RA_TLS_CERT_ALGORITHM=secp256k1
# - RATLS_ENABLE_VERIFY=1
# - RATLS_REQUIRE_PEER_CERT=1
# - RATLS_CERT_PATH=/var/lib/mysql-ssl/server-cert.pem
# - RATLS_KEY_PATH=/app/wallet/mysql-keys/server-key.pem
# - MYSQL_DATA_DIR=/app/wallet/mysql-data

# Expose MySQL port
EXPOSE 3306

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD mysqladmin ping -h localhost --silent || exit 1

# Set working directory to encrypted MySQL data directory
WORKDIR /app/wallet/mysql-data

# The entrypoint runs the base image's entrypoint first (starts aesmd, PCCS, etc.)
# Then runs gramine-sgx with the pre-compiled manifest to start the launcher in SGX enclave
# The launcher (inside enclave) will then execve() to mysqld
# Note: Use full path to manifest because WORKDIR is /app/wallet/mysql-data (encrypted partition)
ENTRYPOINT ["/usr/local/bin/entrypoint.sh", "gramine-sgx", "/var/lib/mysql/mysql-ratls"]
CMD []
