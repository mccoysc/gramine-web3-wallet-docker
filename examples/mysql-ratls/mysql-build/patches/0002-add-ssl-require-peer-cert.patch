From: Devin AI <devin@cognition.ai>
Subject: [PATCH 2/4] Add group_replication_ssl_require_peer_cert parameter

This patch adds a new system variable group_replication_ssl_require_peer_cert
that enforces strict mutual TLS authentication by adding SSL_VERIFY_FAIL_IF_NO_PEER_CERT
flag to the SSL verification mode. When enabled, both client and server must
present valid certificates during the TLS handshake.

This is essential for SGX RA-TLS environments where both nodes must prove
their enclave identity through certificate-based attestation.

---
 plugin/group_replication/include/plugin_variables.h                                              |  3 +++
 plugin/group_replication/src/plugin.cc                                                           | 25 +++++++++++++++++++++++++
 plugin/group_replication/libmysqlgcs/src/bindings/xcom/xcom/network/include/network_provider.h   |  1 +
 plugin/group_replication/libmysqlgcs/src/bindings/xcom/gcs_xcom_interface.cc                     |  8 ++++++++
 plugin/group_replication/libmysqlgcs/src/bindings/xcom/xcom/network/xcom_network_provider_ssl_native_lib.cc | 35 +++++++++++++++++++++++++++++++++++
 plugin/group_replication/libmysqlgcs/src/bindings/xcom/xcom/network/network_provider_manager.h   | 12 ++++++++++++
 plugin/group_replication/libmysqlgcs/src/bindings/xcom/xcom/network/network_provider_manager.cc  |  3 +++
 7 files changed, 87 insertions(+)

diff --git a/plugin/group_replication/include/plugin_variables.h b/plugin/group_replication/include/plugin_variables.h
--- a/plugin/group_replication/include/plugin_variables.h
+++ b/plugin/group_replication/include/plugin_variables.h
@@ -298,6 +298,9 @@ struct plugin_options_variables {
   /* Skip local address check for SGX/Gramine environments */
   bool skip_local_address_check_var{false};
 
+  /* Require peer certificate for strict mutual TLS */
+  bool ssl_require_peer_cert_var{false};
+
   bool allow_single_leader_var{false};
 };
 
diff --git a/plugin/group_replication/src/plugin.cc b/plugin/group_replication/src/plugin.cc
--- a/plugin/group_replication/src/plugin.cc
+++ b/plugin/group_replication/src/plugin.cc
@@ -2639,6 +2639,12 @@ int build_gcs_parameters(Gcs_interface_parameters &gcs_module_parameters) {
   gcs_module_parameters.add_parameter("skip_local_address_check",
                                       skip_local_address_check_string);
 
+  /* SSL require peer certificate parameter for strict mutual TLS */
+  const std::string ssl_require_peer_cert_string =
+      ov.ssl_require_peer_cert_var ? "true" : "false";
+  gcs_module_parameters.add_parameter("ssl_require_peer_cert",
+                                      ssl_require_peer_cert_string);
+
   sv.deinit();
   return result;
 }
@@ -5257,6 +5263,17 @@ static MYSQL_SYSVAR_BOOL(
     nullptr, /* update func*/
     false);  /* default*/
 
+static MYSQL_SYSVAR_BOOL(
+    ssl_require_peer_cert,        /* name */
+    ov.ssl_require_peer_cert_var, /* var */
+    PLUGIN_VAR_OPCMDARG | PLUGIN_VAR_PERSIST_AS_READ_ONLY, /* optional var */
+    "Require peer to present a valid certificate during TLS handshake. "
+    "When enabled, adds SSL_VERIFY_FAIL_IF_NO_PEER_CERT flag for strict "
+    "mutual TLS authentication. Useful for SGX RA-TLS. Default: FALSE.",
+    nullptr, /* check func*/
+    nullptr, /* update func*/
+    false);  /* default*/
+
 static SYS_VAR *group_replication_system_vars[] = {
     MYSQL_SYSVAR(group_name),
     MYSQL_SYSVAR(start_on_boot),
@@ -5334,6 +5351,7 @@ static SYS_VAR *group_replication_system_vars[] = {
     MYSQL_SYSVAR(communication_stack),
     MYSQL_SYSVAR(paxos_single_leader),
     MYSQL_SYSVAR(skip_local_address_check),
+    MYSQL_SYSVAR(ssl_require_peer_cert),
     nullptr,
 };
 
diff --git a/plugin/group_replication/libmysqlgcs/src/bindings/xcom/xcom/network/include/network_provider.h b/plugin/group_replication/libmysqlgcs/src/bindings/xcom/xcom/network/include/network_provider.h
--- a/plugin/group_replication/libmysqlgcs/src/bindings/xcom/xcom/network/include/network_provider.h
+++ b/plugin/group_replication/libmysqlgcs/src/bindings/xcom/xcom/network/include/network_provider.h
@@ -180,6 +180,7 @@ struct ssl_parameters {
   const char *crl_file;
   const char *crl_path;
   const char *cipher;
+  bool ssl_require_peer_cert;
 };
 struct tls_parameters {
   const char *tls_version;
diff --git a/plugin/group_replication/libmysqlgcs/src/bindings/xcom/gcs_xcom_interface.cc b/plugin/group_replication/libmysqlgcs/src/bindings/xcom/gcs_xcom_interface.cc
--- a/plugin/group_replication/libmysqlgcs/src/bindings/xcom/gcs_xcom_interface.cc
+++ b/plugin/group_replication/libmysqlgcs/src/bindings/xcom/gcs_xcom_interface.cc
@@ -1058,6 +1058,11 @@ bool Gcs_xcom_interface::initialize_xcom(
     const std::string *tls_ciphersuites =
         interface_params.get_parameter("tls_ciphersuites");
 
+    /* Parse ssl_require_peer_cert parameter */
+    const std::string *ssl_require_peer_cert_str =
+        interface_params.get_parameter("ssl_require_peer_cert");
+    bool ssl_require_peer_cert = ssl_require_peer_cert_str &&
+        (*ssl_require_peer_cert_str == "true" || *ssl_require_peer_cert_str == "on");
     ssl_parameters ssl_configuration = {
         ssl_mode_int,
         server_key_file ? server_key_file->c_str() : nullptr,
@@ -1068,7 +1073,8 @@ bool Gcs_xcom_interface::initialize_xcom(
         ca_path ? ca_path->c_str() : nullptr,
         crl_file ? crl_file->c_str() : nullptr,
         crl_path ? crl_path->c_str() : nullptr,
-        cipher ? cipher->c_str() : nullptr};
+        cipher ? cipher->c_str() : nullptr,
+        ssl_require_peer_cert};
     tls_parameters tls_configuration = {
         tls_version ? tls_version->c_str() : nullptr,
         tls_ciphersuites ? tls_ciphersuites->c_str() : nullptr};
diff --git a/plugin/group_replication/libmysqlgcs/src/bindings/xcom/xcom/network/network_provider_manager.h b/plugin/group_replication/libmysqlgcs/src/bindings/xcom/xcom/network/network_provider_manager.h
--- a/plugin/group_replication/libmysqlgcs/src/bindings/xcom/xcom/network/network_provider_manager.h
+++ b/plugin/group_replication/libmysqlgcs/src/bindings/xcom/xcom/network/network_provider_manager.h
@@ -360,6 +360,12 @@ class Network_provider_manager : public Network_provider_manager_interface {
   */
   int xcom_get_ssl_fips_mode() override;
 
+  /* SSL require peer certificate getter/setter for strict mutual TLS */
+  void xcom_set_ssl_require_peer_cert(bool require) {
+    m_ssl_require_peer_cert = require;
+  }
+  bool xcom_get_ssl_require_peer_cert() { return m_ssl_require_peer_cert; }
+
   /**
    * @brief Cleans up SSL context.
    */
@@ -373,6 +379,7 @@ class Network_provider_manager : public Network_provider_manager_interface {
       : m_running_protocol(XCOM_PROTOCOL),
         m_incoming_connections_protocol(XCOM_PROTOCOL),
         m_ssl_mode(SSL_DISABLED),
+        m_ssl_require_peer_cert(false),
         m_ssl_fips_mode(FIPS_MODE_OFF) {}
   virtual ~Network_provider_manager() override { m_network_providers.clear(); }
 
@@ -388,6 +395,7 @@ class Network_provider_manager : public Network_provider_manager_interface {
 
   int m_ssl_mode;
   int m_ssl_fips_mode;
+  bool m_ssl_require_peer_cert;
 
   Network_configuration_parameters m_active_provider_configuration;
   Network_configuration_parameters
diff --git a/plugin/group_replication/libmysqlgcs/src/bindings/xcom/xcom/network/network_provider_manager.cc b/plugin/group_replication/libmysqlgcs/src/bindings/xcom/xcom/network/network_provider_manager.cc
--- a/plugin/group_replication/libmysqlgcs/src/bindings/xcom/xcom/network/network_provider_manager.cc
+++ b/plugin/group_replication/libmysqlgcs/src/bindings/xcom/xcom/network/network_provider_manager.cc
@@ -185,6 +185,9 @@ bool Network_provider_manager::configure_active_provider_secure_connections(
   DEEP_COPY_NET_PARAMS_FIELD(tls_params.tls_version);
   DEEP_COPY_NET_PARAMS_FIELD(tls_params.tls_ciphersuites);
 
+  /* Set ssl_require_peer_cert flag from ssl_parameters struct */
+  m_ssl_require_peer_cert = params.ssl_params.ssl_require_peer_cert;
+
   bool config_ssl_ok = true;
   auto net_provider = get_active_provider();
   if (net_provider && is_xcom_using_ssl()) {
diff --git a/plugin/group_replication/libmysqlgcs/src/bindings/xcom/xcom/network/xcom_network_provider_ssl_native_lib.cc b/plugin/group_replication/libmysqlgcs/src/bindings/xcom/xcom/network/xcom_network_provider_ssl_native_lib.cc
--- a/plugin/group_replication/libmysqlgcs/src/bindings/xcom/xcom/network/xcom_network_provider_ssl_native_lib.cc
+++ b/plugin/group_replication/libmysqlgcs/src/bindings/xcom/xcom/network/xcom_network_provider_ssl_native_lib.cc
@@ -510,8 +510,22 @@ int Xcom_network_provider_ssl_library::xcom_init_ssl(
                crl_path, cipher, tls_version, tls_ciphersuites, server_ctx))
     goto error;
 
-  if (Network_provider_manager::getInstance().xcom_get_ssl_mode() !=
-      SSL_REQUIRED)
+  /* Configure server SSL verification mode */
+  {
+    int ssl_mode = Network_provider_manager::getInstance().xcom_get_ssl_mode();
+    bool require_peer_cert =
+        Network_provider_manager::getInstance().xcom_get_ssl_require_peer_cert();
+
+    if (ssl_mode != SSL_REQUIRED) {
+      verify_server = SSL_VERIFY_PEER | SSL_VERIFY_CLIENT_ONCE;
+    }
+
+    /* Add SSL_VERIFY_FAIL_IF_NO_PEER_CERT if require_peer_cert is enabled */
+    if (require_peer_cert) {
+      verify_server |= SSL_VERIFY_PEER | SSL_VERIFY_FAIL_IF_NO_PEER_CERT;
+      G_DEBUG("Server SSL: Adding SSL_VERIFY_FAIL_IF_NO_PEER_CERT flag");
+    }
+  }
   SSL_CTX_set_verify(server_ctx, verify_server, nullptr);
 
@@ -527,9 +541,22 @@ int Xcom_network_provider_ssl_library::xcom_init_ssl(
   if (init_ssl(client_key_file, client_cert_file, ca_file, ca_path, crl_file,
                crl_path, cipher, tls_version, tls_ciphersuites, client_ctx))
     goto error;
-
-  if (Network_provider_manager::getInstance().xcom_get_ssl_mode() !=
-      SSL_REQUIRED) {
+
+  /* Configure client SSL verification mode */
+  {
+    int ssl_mode = Network_provider_manager::getInstance().xcom_get_ssl_mode();
+    bool require_peer_cert =
+        Network_provider_manager::getInstance().xcom_get_ssl_require_peer_cert();
+
+    if (ssl_mode != SSL_REQUIRED) {
+      verify_client = SSL_VERIFY_PEER;
+    }
+
+    /* Add SSL_VERIFY_FAIL_IF_NO_PEER_CERT if require_peer_cert is enabled */
+    if (require_peer_cert) {
+      verify_client |= SSL_VERIFY_PEER | SSL_VERIFY_FAIL_IF_NO_PEER_CERT;
+      G_DEBUG("Client SSL: Adding SSL_VERIFY_FAIL_IF_NO_PEER_CERT flag");
+    }
+  }
   SSL_CTX_set_verify(client_ctx, verify_client, nullptr);
-- 
2.39.0
