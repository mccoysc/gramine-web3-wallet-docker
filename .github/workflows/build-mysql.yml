name: Build MySQL with GR Patches

on:
  workflow_dispatch:
    inputs:
      mysql_version:
        description: 'MySQL version to build'
        required: false
        type: string
        default: '8.0.40'
      force_rebuild:
        description: 'Force rebuild even if prebuilt exists'
        required: false
        type: boolean
        default: false
  push:
    branches:
      - main
      - master
    paths:
      - 'examples/mysql-ratls/mysql-build/**'
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'examples/mysql-ratls/mysql-build/**'

# Global repository-wide concurrency control
concurrency:
  group: repo-wide-mutex-${{ github.repository }}
  cancel-in-progress: false

env:
  MYSQL_VERSION: ${{ github.event.inputs.mysql_version || '8.0.40' }}

jobs:
  # Job 1: Check if MySQL build is needed
  check-mysql-version:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      needs_build: ${{ steps.check.outputs.needs_build }}
      mysql_version: ${{ steps.check.outputs.mysql_version }}
      patches_changed: ${{ steps.check.outputs.patches_changed }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if MySQL build is needed
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            const mysqlVersion = '${{ env.MYSQL_VERSION }}';
            const forceRebuild = '${{ github.event.inputs.force_rebuild }}' === 'true';
            
            // Helper to read version file
            function readVersionFile(filePath) {
              try {
                if (fs.existsSync(filePath)) {
                  return fs.readFileSync(filePath, 'utf8').trim();
                }
              } catch (e) {
                console.log(`Could not read ${filePath}: ${e.message}`);
              }
              return '';
            }
            
            // Helper to check if a prebuilt asset exists in GitHub Releases
            async function releaseAssetExists(tag, assetName) {
              try {
                const { data: release } = await github.rest.repos.getReleaseByTag({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  tag
                });
                const asset = release.assets.find(a => a.name === assetName);
                return !!asset;
              } catch (error) {
                if (error.status === 404) {
                  return false;
                }
                console.log(`Warning: Failed to check release ${tag}: ${error.message}`);
                return false;
              }
            }
            
            // Check if patches changed
            let patchesChanged = false;
            
            if (context.eventName === 'pull_request') {
              const prNumber = context.payload.pull_request.number;
              const files = await github.paginate(github.rest.pulls.listFiles, {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                per_page: 100
              });
              
              patchesChanged = files.some(f => 
                f.filename.startsWith('examples/mysql-ratls/mysql-build/patches/')
              );
              
              if (patchesChanged) {
                console.log('MySQL patches changed in this PR');
              }
            } else if (context.eventName === 'push') {
              const base = context.payload.before;
              const head = context.sha;
              
              if (base && base !== '0000000000000000000000000000000000000000') {
                try {
                  const comparison = await github.rest.repos.compareCommits({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    base,
                    head
                  });
                  
                  patchesChanged = (comparison.data.files || []).some(f =>
                    f.filename.startsWith('examples/mysql-ratls/mysql-build/patches/')
                  );
                  
                  if (patchesChanged) {
                    console.log('MySQL patches changed in this push');
                  }
                } catch (error) {
                  console.log(`Warning: Could not compare commits: ${error.message}`);
                }
              }
            }
            
            // Check if prebuilt MySQL exists
            const mysqlTag = `prebuilt-mysql-${mysqlVersion}`;
            const mysqlAsset = `mysql-install-${mysqlVersion}.tar.gz`;
            const mysqlExists = await releaseAssetExists(mysqlTag, mysqlAsset);
            
            // Check current version
            const currentVersion = readVersionFile('prebuilt/mysql/VERSION');
            const versionChanged = currentVersion !== mysqlVersion;
            
            // Determine if build is needed
            const needsBuild = forceRebuild || patchesChanged || versionChanged || !mysqlExists;
            
            console.log(`MySQL version: ${mysqlVersion}`);
            console.log(`Current version: ${currentVersion || 'none'}`);
            console.log(`Prebuilt exists: ${mysqlExists}`);
            console.log(`Patches changed: ${patchesChanged}`);
            console.log(`Version changed: ${versionChanged}`);
            console.log(`Force rebuild: ${forceRebuild}`);
            console.log(`Needs build: ${needsBuild}`);
            
            core.setOutput('needs_build', needsBuild.toString());
            core.setOutput('mysql_version', mysqlVersion);
            core.setOutput('patches_changed', patchesChanged.toString());
            
            // Create summary
            core.summary
              .addHeading('MySQL Build Check')
              .addTable([
                [{data: 'Property', header: true}, {data: 'Value', header: true}],
                ['MySQL Version', mysqlVersion],
                ['Current Version', currentVersion || 'none'],
                ['Prebuilt Exists', mysqlExists ? 'Yes' : 'No'],
                ['Patches Changed', patchesChanged ? 'Yes' : 'No'],
                ['Needs Build', needsBuild ? 'Yes' : 'No']
              ])
              .write();

  # Job 2: Build MySQL with patches
  build-mysql:
    runs-on: ubuntu-latest
    needs: check-mysql-version
    if: needs.check-mysql-version.outputs.needs_build == 'true'
    permissions:
      contents: write
    container:
      image: ubuntu:22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y \
            build-essential \
            cmake \
            pkg-config \
            libssl-dev \
            libncurses5-dev \
            libudev-dev \
            libtirpc-dev \
            rpcsvc-proto \
            bison \
            libaio-dev \
            libldap2-dev \
            libsasl2-dev \
            libcurl4-openssl-dev \
            libevent-dev \
            libmecab-dev \
            libnuma-dev \
            libprotobuf-dev \
            libprotoc-dev \
            protobuf-compiler \
            zlib1g-dev \
            liblz4-dev \
            libzstd-dev \
            libreadline-dev \
            wget \
            ca-certificates \
            git \
            patch

      - name: Download MySQL source
        run: |
          VERSION="${{ needs.check-mysql-version.outputs.mysql_version }}"
          echo "Downloading MySQL ${VERSION} source..."
          
          cd /tmp
          wget -q "https://dev.mysql.com/get/Downloads/MySQL-8.0/mysql-${VERSION}.tar.gz"
          tar -xzf "mysql-${VERSION}.tar.gz"
          
          echo "MySQL source downloaded and extracted"

      - name: Apply custom patches
        run: |
          VERSION="${{ needs.check-mysql-version.outputs.mysql_version }}"
          PATCHES_DIR="${GITHUB_WORKSPACE}/examples/mysql-ratls/mysql-build/patches"
          
          cd "/tmp/mysql-${VERSION}"
          
          echo "Applying custom patches from ${PATCHES_DIR}..."
          
          for patch_file in "${PATCHES_DIR}"/*.patch; do
            if [ -f "$patch_file" ]; then
              echo "Applying patch: $(basename "$patch_file")"
              patch -p1 < "$patch_file" || {
                echo "Warning: Patch may already be applied or has conflicts: $(basename "$patch_file")"
              }
            fi
          done
          
          echo "Patches applied"

      - name: Configure MySQL build
        run: |
          VERSION="${{ needs.check-mysql-version.outputs.mysql_version }}"
          
          cd "/tmp/mysql-${VERSION}"
          mkdir -p build
          cd build
          
          cmake .. \
            -DCMAKE_INSTALL_PREFIX=/opt/mysql-install \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DWITH_SSL=system \
            -DWITH_ZLIB=bundled \
            -DWITH_LZ4=bundled \
            -DWITH_ZSTD=bundled \
            -DWITH_PROTOBUF=bundled \
            -DWITH_BOOST=/tmp/boost \
            -DDOWNLOAD_BOOST=1 \
            -DWITH_INNODB_MEMCACHED=OFF \
            -DWITH_ROUTER=OFF \
            -DWITH_UNIT_TESTS=OFF \
            -DWITH_DEBUG=OFF \
            -DWITH_AUTHENTICATION_LDAP=OFF \
            -DWITH_AUTHENTICATION_KERBEROS=OFF \
            -DWITH_AUTHENTICATION_FIDO=OFF \
            -DWITH_NDB=OFF \
            -DWITH_NDBCLUSTER=OFF \
            -DWITH_EXAMPLE_STORAGE_ENGINE=OFF \
            -DWITH_FEDERATED_STORAGE_ENGINE=OFF \
            -DWITH_ARCHIVE_STORAGE_ENGINE=OFF \
            -DWITH_BLACKHOLE_STORAGE_ENGINE=OFF \
            -DFORCE_INSOURCE_BUILD=1 \
            -DWITH_GROUP_REPLICATION=ON \
            -DENABLED_LOCAL_INFILE=ON \
            -DMYSQL_UNIX_ADDR=/var/run/mysqld/mysqld.sock \
            -DMYSQL_DATADIR=/var/lib/mysql \
            -DSYSCONFDIR=/etc/mysql
          
          echo "MySQL build configured"

      - name: Build MySQL
        run: |
          VERSION="${{ needs.check-mysql-version.outputs.mysql_version }}"
          
          cd "/tmp/mysql-${VERSION}/build"
          
          # Use available CPU cores for parallel build
          make -j$(nproc)
          
          echo "MySQL build completed"

      - name: Install MySQL
        run: |
          VERSION="${{ needs.check-mysql-version.outputs.mysql_version }}"
          
          cd "/tmp/mysql-${VERSION}/build"
          make install
          
          echo "MySQL installed to /opt/mysql-install"
          
          # Verify installation
          ls -la /opt/mysql-install/bin/
          /opt/mysql-install/bin/mysqld --version

      - name: Create tarball
        run: |
          VERSION="${{ needs.check-mysql-version.outputs.mysql_version }}"
          
          cd /opt
          tar -czf "mysql-install-${VERSION}.tar.gz" mysql-install/
          ls -lh "mysql-install-${VERSION}.tar.gz"
          sha256sum "mysql-install-${VERSION}.tar.gz" > "mysql-install-${VERSION}.tar.gz.sha256"
          
          echo "Tarball created"

      - name: Upload to GitHub Releases
        uses: softprops/action-gh-release@v1
        with:
          tag_name: prebuilt-mysql-${{ needs.check-mysql-version.outputs.mysql_version }}
          name: MySQL ${{ needs.check-mysql-version.outputs.mysql_version }} with GR Patches
          body: |
            MySQL ${{ needs.check-mysql-version.outputs.mysql_version }} compiled with custom Group Replication patches for SGX/Gramine environments.
            
            **Patches included:**
            - `group_replication_skip_local_address_check` - Skip local IP validation (required for Gramine)
            - `group_replication_ssl_require_peer_cert` - Enforce strict mutual TLS authentication
            - `group_replication_ssl_allow_self_signed` - Accept self-signed certificates (for RA-TLS)
            - `group_replication_communication_debug_path` - Custom GCS debug trace path
            
            **Build info:**
            - Commit: ${{ github.sha }}
            - Workflow run: ${{ github.run_id }}
          files: |
            /opt/mysql-install-${{ needs.check-mysql-version.outputs.mysql_version }}.tar.gz
            /opt/mysql-install-${{ needs.check-mysql-version.outputs.mysql_version }}.tar.gz.sha256
          draft: false
          prerelease: false

      - name: Upload artifact for this workflow run
        uses: actions/upload-artifact@v4
        with:
          name: mysql-build
          path: /opt/mysql-install-${{ needs.check-mysql-version.outputs.mysql_version }}.tar.gz
          retention-days: 7

      - name: Generate build summary
        run: |
          VERSION="${{ needs.check-mysql-version.outputs.mysql_version }}"
          
          echo "## MySQL Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **MySQL Version**: ${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Type**: RelWithDebInfo" >> $GITHUB_STEP_SUMMARY
          echo "- **Group Replication**: Enabled" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Custom Patches Applied" >> $GITHUB_STEP_SUMMARY
          echo "- \`group_replication_skip_local_address_check\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`group_replication_ssl_require_peer_cert\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`group_replication_ssl_allow_self_signed\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`group_replication_communication_debug_path\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Release tag: \`prebuilt-mysql-${VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Tarball: \`mysql-install-${VERSION}.tar.gz\`" >> $GITHUB_STEP_SUMMARY
