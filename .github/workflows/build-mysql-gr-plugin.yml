name: Build MySQL GR Plugin

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'examples/mysql-ratls/files/mysql-gr-patch/**'
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'examples/mysql-ratls/files/mysql-gr-patch/**'
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild the plugin'
        required: false
        type: boolean
        default: false

# Repository-wide concurrency control
concurrency:
  group: mysql-gr-plugin-${{ github.repository }}
  cancel-in-progress: false

env:
  MYSQL_VERSION: "8.0.44"
  MYSQL_UBUNTU_VERSION: "8.0.44-0ubuntu0.22.04.2"

jobs:
  build-plugin:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            libssl-dev \
            libncurses5-dev \
            libtirpc-dev \
            bison \
            pkg-config \
            libudev-dev \
            libldap2-dev \
            libsasl2-dev \
            libevent-dev \
            libcurl4-openssl-dev \
            liblz4-dev \
            zlib1g-dev \
            libzstd-dev \
            libprotobuf-dev \
            protobuf-compiler \
            rapidjson-dev

      - name: Download MySQL source
        run: |
          echo "Downloading MySQL ${{ env.MYSQL_VERSION }} source..."
          
          # Download MySQL source from Ubuntu package
          mkdir -p mysql-source
          cd mysql-source
          
          # Get the source package
          apt-get source mysql-server-8.0=${{ env.MYSQL_UBUNTU_VERSION }} 2>/dev/null || {
            # Fallback: download from MySQL archives
            wget -q "https://downloads.mysql.com/archives/get/p/23/file/mysql-${{ env.MYSQL_VERSION }}.tar.gz"
            tar xzf mysql-${{ env.MYSQL_VERSION }}.tar.gz
            mv mysql-${{ env.MYSQL_VERSION }} mysql-8.0-${{ env.MYSQL_VERSION }}
          }
          
          echo "MySQL source downloaded"
          ls -la

      - name: Apply patches
        run: |
          MYSQL_DIR=$(find mysql-source -maxdepth 1 -type d -name "mysql-8.0*" | head -1)
          echo "MySQL source directory: $MYSQL_DIR"
          
          PATCH_DIR="${{ github.workspace }}/examples/mysql-ratls/files/mysql-gr-patch"
          
          # Copy gr_getifaddrs files to xcom directory
          XCOM_DIR="$MYSQL_DIR/plugin/group_replication/libmysqlgcs/src/bindings/xcom/xcom"
          cp "$PATCH_DIR/gr_getifaddrs.h" "$XCOM_DIR/"
          cp "$PATCH_DIR/gr_getifaddrs.cc" "$XCOM_DIR/"
          cp "$PATCH_DIR/sock_probe_ix.h" "$XCOM_DIR/"
          
          # Copy recovery_endpoints.cc
          cp "$PATCH_DIR/recovery_endpoints.cc" "$MYSQL_DIR/plugin/group_replication/src/plugin_variables/"
          
          # Copy CMakeLists.txt for libmysqlgcs
          cp "$PATCH_DIR/CMakeLists.txt" "$MYSQL_DIR/plugin/group_replication/libmysqlgcs/"
          
          echo "Patches applied successfully"

      - name: Configure MySQL build
        run: |
          MYSQL_DIR=$(find mysql-source -maxdepth 1 -type d -name "mysql-8.0*" | head -1)
          
          mkdir -p mysql-build
          cd mysql-build
          
          cmake "../$MYSQL_DIR" \
            -DCMAKE_BUILD_TYPE=Release \
            -DWITH_SSL=system \
            -DWITH_ZLIB=system \
            -DWITH_LZ4=system \
            -DWITH_ZSTD=system \
            -DWITH_PROTOBUF=system \
            -DWITH_RAPIDJSON=system \
            -DWITH_BOOST=../boost \
            -DDOWNLOAD_BOOST=1 \
            -DWITH_UNIT_TESTS=OFF \
            -DWITH_DEBUG=OFF \
            -DFORCE_INSOURCE_BUILD=1

      - name: Build Group Replication plugin
        run: |
          cd mysql-build
          
          # Build only the group_replication plugin and its dependencies
          make -j$(nproc) group_replication
          
          echo "Build completed"
          
          # Find the built plugin
          find . -name "group_replication.so" -type f

      - name: Package plugin
        id: package
        run: |
          mkdir -p plugin-package
          
          # Find and copy the built plugin
          PLUGIN_PATH=$(find mysql-build -name "group_replication.so" -type f | head -1)
          if [ -z "$PLUGIN_PATH" ]; then
            echo "ERROR: group_replication.so not found!"
            exit 1
          fi
          
          cp "$PLUGIN_PATH" plugin-package/
          
          # Create version info
          echo "MySQL Version: ${{ env.MYSQL_VERSION }}" > plugin-package/VERSION.txt
          echo "Ubuntu Package: ${{ env.MYSQL_UBUNTU_VERSION }}" >> plugin-package/VERSION.txt
          echo "Build Date: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> plugin-package/VERSION.txt
          echo "Commit: ${{ github.sha }}" >> plugin-package/VERSION.txt
          
          # Create tarball
          PACKAGE_NAME="mysql-gr-plugin-${{ env.MYSQL_VERSION }}-sgx.tar.gz"
          tar -czvf "$PACKAGE_NAME" -C plugin-package .
          
          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "Package created: $PACKAGE_NAME"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mysql-gr-plugin
          path: mysql-gr-plugin-*.tar.gz
          retention-days: 30

      - name: Create or update release
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PACKAGE_NAME="${{ steps.package.outputs.package_name }}"
          TAG_NAME="mysql-gr-plugin-${{ env.MYSQL_VERSION }}"
          
          # Check if release exists
          if gh release view "$TAG_NAME" > /dev/null 2>&1; then
            echo "Updating existing release $TAG_NAME..."
            # Delete old asset if exists
            gh release delete-asset "$TAG_NAME" "$PACKAGE_NAME" --yes 2>/dev/null || true
            # Upload new asset
            gh release upload "$TAG_NAME" "$PACKAGE_NAME" --clobber
          else
            echo "Creating new release $TAG_NAME..."
            gh release create "$TAG_NAME" \
              --title "MySQL Group Replication Plugin ${{ env.MYSQL_VERSION }} (SGX/Gramine)" \
              --notes "MySQL Group Replication plugin patched for SGX/Gramine environments.

This plugin includes a custom gr_getifaddrs() implementation that works in Gramine where the standard getifaddrs() is not available.

## Features
- Supports GR_LOCAL_IP environment variable (comma-separated list)
- Auto-detects local IP via UDP socket if env var not set
- Compatible with MySQL ${{ env.MYSQL_UBUNTU_VERSION }}

## Usage
Replace /usr/lib/mysql/plugin/group_replication.so with this version.

Set GR_LOCAL_IP environment variable:
\`\`\`bash
export GR_LOCAL_IP=192.168.1.100,203.0.113.50
\`\`\`" \
              "$PACKAGE_NAME"
          fi
          
          echo "Release $TAG_NAME updated with $PACKAGE_NAME"
